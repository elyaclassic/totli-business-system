{% extends "base.html" %}

{% block content %}
<style>
    #partner_search_results, .product_search_results {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        margin-top: 2px;
        background: white;
        z-index: 1050 !important;
        overflow-y: auto;
        overflow-x: hidden;
    }
    #partner_search_results .list-group-item:hover, .product_search_results .list-group-item:hover { 
        background-color: #f8f9fa; 
        cursor: pointer; 
    }
    .product-search-wrapper {
        position: relative !important;
    }
    .product_search_results {
        position: fixed !important;
        z-index: 9999 !important;
        max-height: 300px !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        display: none !important;
        background: white !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 0.25rem !important;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15) !important;
    }
    .product_search_results.show {
        display: block !important;
    }
    /* Jadval ichida overflow muammosini hal qilish */
    #productsTable {
        table-layout: auto;
    }
    #productsTable td {
        position: relative !important;
        overflow: visible !important;
    }
    #productsTable tbody tr {
        position: relative !important;
    }
    .table-responsive {
        overflow: visible !important;
    }
    /* Scrollbar styling */
    .product_search_results::-webkit-scrollbar {
        width: 8px;
    }
    .product_search_results::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    .product_search_results::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    .product_search_results::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <a href="/purchases" class="btn btn-outline-secondary mb-3">
                <i class="bi bi-arrow-left"></i> Orqaga
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Yangi tovar kirimi</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="/purchases/create" id="purchaseCreateForm">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3 position-relative">
                            <label class="form-label">Ta'minotchi *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="partner_search_input"
                                    placeholder="Nomi, telefon yoki kod bo'yicha qidiring..." autocomplete="off" required>
                                <input type="hidden" name="partner_id" id="partner_id_hidden" required>
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addPartnerModal">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                            <div id="partner_search_results" class="list-group position-absolute"
                                style="z-index: 1000; max-height: 260px; overflow-y: auto; display: none; left: 0; right: 0;"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Ombor *</label>
                            <select name="warehouse_id" class="form-select" required>
                                <option value="">Tanlang...</option>
                                {% for warehouse in warehouses %}
                                <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <select id="partner_select" style="display: none;">
                    <option value="">Tanlang...</option>
                    {% for partner in partners %}
                    <option value="{{ partner.id }}" data-name="{{ partner.name }}"
                        data-phone="{{ partner.phone or '' }}" data-code="{{ partner.code or '' }}">
                        {{ partner.name }} (#{{ partner.id }}{% if partner.code %} â€” {{ partner.code }}{% endif %})
                    </option>
                    {% endfor %}
                </select>

                <select id="product_select" style="display: none;">
                    <option value="">Tanlang...</option>
                    {% for product in products %}
                    <option value="{{ product.id }}" data-name="{{ product.name }}" data-code="{{ product.code or '' }}">
                        {{ product.name }}{% if product.code %} ({{ product.code }}){% endif %}
                    </option>
                    {% endfor %}
                </select>

                <!-- Mahsulotlar jadvali -->
                <h6 class="mb-2">Mahsulotlar</h6>
                <div class="mb-3" style="position: relative;">
                    <div class="table-responsive">
                        <table class="table table-sm" id="productsTable">
                            <thead>
                                <tr>
                                    <th>Mahsulot</th>
                                    <th style="width: 120px;">Miqdor</th>
                                    <th style="width: 140px;">Narx (so'm)</th>
                                    <th style="width: 100px;"></th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr class="product-row">
                                    <td style="position: relative;">
                                        <div class="product-search-wrapper">
                                            <input type="text" class="form-control form-select-sm product-search-input" 
                                                placeholder="Nomi yoki kod bo'yicha qidiring..." autocomplete="off">
                                            <input type="hidden" name="product_id" class="product-id-hidden">
                                            <div class="product_search_results list-group" style="display: none;"></div>
                                        </div>
                                    </td>
                                    <td><input type="number" name="quantity" class="form-control form-control-sm" step="0.01" min="0" placeholder="0"></td>
                                    <td><input type="number" name="price" class="form-control form-control-sm" step="0.01" min="0" placeholder="0"></td>
                                    <td><button type="button" class="btn btn-sm btn-outline-danger remove-product-row" title="O'chirish"><i class="bi bi-trash"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm mb-4" id="addProductRow">
                    <i class="bi bi-plus-circle"></i> Qator qo'shish
                </button>

                <!-- Xarajatlar -->
                <h6 class="mb-2">Xarajatlar</h6>
                <div class="table-responsive mb-3">
                    <table class="table table-sm" id="expensesTable">
                        <thead>
                            <tr>
                                <th>Xarajat nomi</th>
                                <th style="width: 160px;">Summa (so'm)</th>
                                <th style="width: 100px;"></th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <tr class="expense-row">
                                <td><input type="text" name="expense_name" class="form-control form-control-sm" placeholder="masalan: Yo'l, Yuk, Boj"></td>
                                <td><input type="number" name="expense_amount" class="form-control form-control-sm" step="0.01" min="0" placeholder="0"></td>
                                <td><button type="button" class="btn btn-sm btn-outline-danger remove-expense-row" title="O'chirish"><i class="bi bi-trash"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm mb-4" id="addExpenseRow">
                    <i class="bi bi-plus-circle"></i> Xarajat qo'shish
                </button>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Saqlash
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Kontragent qo'shish modal -->
<div class="modal fade" id="addPartnerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="addPartnerForm">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Yangi kontragent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-9">
                            <label class="form-label">Nomi *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Turi *</label>
                            <select class="form-select" name="type" required>
                                <option value="supplier" selected>Yetkazib beruvchi</option>
                                <option value="customer">Mijoz</option>
                                <option value="both">Ikkalasi</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telefon</label>
                            <input type="text" class="form-control" name="phone" placeholder="+998 XX XXX XX XX">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Manzil</label>
                            <input type="text" class="form-control" name="address">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor</button>
                    <button type="submit" class="btn btn-success">Saqlash</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
(function() {
    const partnerInput = document.getElementById('partner_search_input');
    const partnerIdHidden = document.getElementById('partner_id_hidden');
    const searchResults = document.getElementById('partner_search_results');
    const partnerSelect = document.getElementById('partner_select');

    if (partnerInput && partnerSelect) {
        partnerInput.addEventListener('input', function() {
            const searchTerm = (this.value || '').trim().toLowerCase();
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
            partnerIdHidden.value = '';
            if (!searchTerm) return;
            const options = Array.from(partnerSelect.options).slice(1);
            const matches = options.filter(function(opt) {
                const name = (opt.dataset.name || '').toLowerCase();
                const phone = (opt.dataset.phone || '').toLowerCase();
                const code = (opt.dataset.code || '').toLowerCase();
                const id = (opt.value || '').toString();
                return name.indexOf(searchTerm) !== -1 || phone.indexOf(searchTerm) !== -1 ||
                    code.indexOf(searchTerm) !== -1 || id === searchTerm;
            });
            if (matches.length > 0) {
                matches.forEach(function(opt) {
                    const item = document.createElement('a');
                    item.href = '#'; item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = '<strong>' + (opt.dataset.name || '') + '</strong> <span class="badge bg-secondary">#' + opt.value + '</span>';
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        partnerInput.value = opt.dataset.name || '';
                        partnerIdHidden.value = opt.value;
                        searchResults.style.display = 'none';
                    });
                    searchResults.appendChild(item);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.innerHTML = '<div class="list-group-item text-muted">Topilmadi. "+" tugmasini bosing.</div>';
                searchResults.style.display = 'block';
            }
        });
        document.addEventListener('click', function(e) {
            if (!partnerInput.contains(e.target) && !searchResults.contains(e.target)) searchResults.style.display = 'none';
        });
    }

    // Mahsulot qidirish funksiyasi
    const productSelect = document.getElementById('product_select');
    
    function initProductSearch(row) {
        const searchInput = row.querySelector('.product-search-input');
        const hiddenInput = row.querySelector('.product-id-hidden');
        const resultsDiv = row.querySelector('.product_search_results');
        
        if (!searchInput || !hiddenInput || !resultsDiv) {
            console.error('Product search elements not found in row:', row);
            return;
        }
        
        if (!productSelect) {
            console.error('product_select element not found');
            return;
        }
        
        function showProductResults(term) {
            term = (term || '').trim().toLowerCase();
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('show');
            resultsDiv.style.setProperty('display', 'none', 'important');
            
            if (!term) {
                hiddenInput.value = '';
                return;
            }
            
            const options = Array.from(productSelect.options).slice(1);
            const matches = options.filter(function(opt) {
                const name = (opt.dataset.name || opt.textContent || '').toLowerCase();
                const code = (opt.dataset.code || '').toLowerCase();
                const id = (opt.value || '').toString();
                return name.indexOf(term) !== -1 || code.indexOf(term) !== -1 || id === term;
            });
            
            if (matches.length > 0) {
                console.log('Found', matches.length, 'product matches');
                // Dropdown pozitsiyasini hisoblash (fixed position uchun)
                const inputRect = searchInput.getBoundingClientRect();
                resultsDiv.style.position = 'fixed';
                resultsDiv.style.left = inputRect.left + 'px';
                resultsDiv.style.top = (inputRect.bottom + 2) + 'px';
                resultsDiv.style.width = inputRect.width + 'px';
                resultsDiv.style.maxHeight = '300px';
                resultsDiv.style.overflowY = 'auto';
                resultsDiv.style.zIndex = '9999';
                resultsDiv.classList.add('show');
                resultsDiv.style.setProperty('display', 'block', 'important');
                
                matches.forEach(function(opt) {
                    const item = document.createElement('a');
                    item.href = '#'; 
                    item.className = 'list-group-item list-group-item-action';
                    const displayName = opt.dataset.name || opt.textContent || '';
                    const displayCode = opt.dataset.code || '';
                    item.innerHTML = '<strong>' + displayName + '</strong>' + 
                        (displayCode ? ' <span class="badge bg-secondary">' + displayCode + '</span>' : '');
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        searchInput.value = displayName + (displayCode ? ' (' + displayCode + ')' : '');
                        hiddenInput.value = opt.value;
                        resultsDiv.classList.remove('show');
                        resultsDiv.style.setProperty('display', 'none', 'important');
                        
                        // Mahsulot tanlanganda avtomatik narxni ko'rsatish
                        updateProductPrice(row);
                    });
                    resultsDiv.appendChild(item);
                });
            } else {
                // Topilmadi xabari
                const inputRect = searchInput.getBoundingClientRect();
                resultsDiv.style.position = 'fixed';
                resultsDiv.style.left = inputRect.left + 'px';
                resultsDiv.style.top = (inputRect.bottom + 2) + 'px';
                resultsDiv.style.width = inputRect.width + 'px';
                resultsDiv.style.zIndex = '9999';
                resultsDiv.classList.add('show');
                resultsDiv.style.setProperty('display', 'block', 'important');
                resultsDiv.innerHTML = '<div class="list-group-item text-muted">Topilmadi.</div>';
            }
        }
        
        // Mahsulot narxini yangilash funksiyasi
        function updateProductPrice(row) {
            const hiddenInput = row.querySelector('.product-id-hidden');
            const priceInput = row.querySelector('input[name="price"]');
            const warehouseSelect = document.querySelector('select[name="warehouse_id"]');
            
            if (!hiddenInput || !priceInput || !warehouseSelect) return;
            
            const productId = hiddenInput.value;
            const warehouseId = warehouseSelect.value;
            
            if (!productId || !warehouseId) {
                priceInput.value = '';
                return;
            }
            
            // API dan narxni olish
            fetch(`/purchases/api/product-price?product_id=${productId}&warehouse_id=${warehouseId}`)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data && data.price && data.price > 0) {
                        priceInput.value = parseFloat(data.price).toFixed(2);
                        // Narx o'zgarganda totalni yangilash
                        const qtyInput = row.querySelector('input[name="quantity"]');
                        if (qtyInput) {
                            const qty = parseFloat(qtyInput.value) || 0;
                            const price = parseFloat(priceInput.value) || 0;
                            // Total avtomatik hisoblanadi form submit qilganda
                        }
                    }
                })
                .catch(function(e) {
                    console.error('Narx olishda xatolik:', e);
                });
        }
        
        // Ombor o'zgarganda barcha qatorlardagi narxlarni yangilash
        const warehouseSelect = document.querySelector('select[name="warehouse_id"]');
        if (warehouseSelect) {
            warehouseSelect.addEventListener('change', function() {
                document.querySelectorAll('.product-row').forEach(function(row) {
                    const hiddenInput = row.querySelector('.product-id-hidden');
                    if (hiddenInput && hiddenInput.value) {
                        updateProductPrice(row);
                    }
                });
            });
        }
        
        searchInput.addEventListener('focus', function() {
            const currentValue = this.value.trim();
            if (currentValue) {
                showProductResults(currentValue);
            }
        });
        
        searchInput.addEventListener('input', function() {
            const value = this.value.trim();
            console.log('Product search input:', value);
            showProductResults(value);
        });
        
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                resultsDiv.classList.remove('show');
                resultsDiv.style.setProperty('display', 'none', 'important');
            }
        });
        
        // Tashqariga bosilganda yopish
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.classList.remove('show');
                resultsDiv.style.setProperty('display', 'none', 'important');
            }
        });
    }
    
    // Mavjud qatorlar uchun qidirishni ishga tushirish
    if (productSelect) {
        console.log('Product select found, initializing search for', document.querySelectorAll('#productsTableBody .product-row').length, 'rows');
        document.querySelectorAll('#productsTableBody .product-row').forEach(function(row) {
            initProductSearch(row);
        });
    } else {
        console.error('product_select element not found - product search will not work');
    }

    document.getElementById('purchaseCreateForm').addEventListener('submit', function(e) {
        if (!(partnerIdHidden && partnerIdHidden.value)) {
            e.preventDefault();
            if (partnerInput) partnerInput.focus();
            alert('Ta\'minotchini qidiruv orqali tanlang.');
            return;
        }
        const productRows = document.querySelectorAll('#productsTableBody .product-row');
        let hasProduct = false;
        productRows.forEach(function(row) {
            const hiddenInput = row.querySelector('.product-id-hidden');
            const qty = row.querySelector('input[name="quantity"]');
            const price = row.querySelector('input[name="price"]');
            if (hiddenInput && hiddenInput.value && parseFloat(qty && qty.value) > 0 && parseFloat(price && price.value) >= 0) hasProduct = true;
        });
        if (!hasProduct) {
            e.preventDefault();
            alert('Kamida bitta mahsulot qo\'shing (mahsulot, miqdor va narx kiriting).');
            return;
        }
    });

    document.querySelectorAll('#productsTableBody .remove-product-row').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var tbody = document.getElementById('productsTableBody');
            if (tbody.querySelectorAll('.product-row').length > 1) btn.closest('tr').remove();
        });
    });

    document.getElementById('addProductRow').addEventListener('click', function() {
        var tbody = document.getElementById('productsTableBody');
        var firstRow = tbody.querySelector('.product-row');
        if (!firstRow) return;
        var newRow = firstRow.cloneNode(true);
        newRow.querySelector('.product-search-input').value = '';
        newRow.querySelector('.product-id-hidden').value = '';
        newRow.querySelector('input[name="quantity"]').value = '';
        newRow.querySelector('input[name="price"]').value = '';
        tbody.appendChild(newRow);
        newRow.querySelector('.remove-product-row').addEventListener('click', function() {
            if (tbody.querySelectorAll('.product-row').length > 1) newRow.remove();
        });
        // Yangi qator uchun qidirishni ishga tushirish
        initProductSearch(newRow);
        
        // Yangi qator uchun narxni avtomatik to'ldirish funksiyasini qo'shish
        const newHiddenInput = newRow.querySelector('.product-id-hidden');
        const newPriceInput = newRow.querySelector('input[name="price"]');
        const warehouseSelect = document.querySelector('select[name="warehouse_id"]');
        
        if (newHiddenInput && newPriceInput && warehouseSelect) {
            function updateNewRowPrice() {
                const productId = newHiddenInput.value;
                const warehouseId = warehouseSelect.value;
                
                if (!productId || !warehouseId) {
                    newPriceInput.value = '';
                    return;
                }
                
                fetch(`/purchases/api/product-price?product_id=${productId}&warehouse_id=${warehouseId}`)
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data && data.price && data.price > 0) {
                            newPriceInput.value = parseFloat(data.price).toFixed(2);
                        }
                    })
                    .catch(function(e) {
                        console.error('Narx olishda xatolik:', e);
                    });
            }
            
            newHiddenInput.addEventListener('change', updateNewRowPrice);
        }
    });

    document.querySelectorAll('#expensesTableBody .remove-expense-row').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var tbody = document.getElementById('expensesTableBody');
            if (tbody.querySelectorAll('.expense-row').length > 1) btn.closest('tr').remove();
        });
    });

    document.getElementById('addExpenseRow').addEventListener('click', function() {
        var tbody = document.getElementById('expensesTableBody');
        var firstRow = tbody.querySelector('.expense-row');
        if (!firstRow) return;
        var newRow = firstRow.cloneNode(true);
        newRow.querySelector('input[name="expense_name"]').value = '';
        newRow.querySelector('input[name="expense_amount"]').value = '';
        tbody.appendChild(newRow);
        newRow.querySelector('.remove-expense-row').addEventListener('click', function() {
            if (tbody.querySelectorAll('.expense-row').length > 1) newRow.remove();
        });
    });

    document.getElementById('addPartnerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var formData = new FormData(this);
        fetch('/partners/add', { method: 'POST', body: formData })
            .then(function(r) { if (r.ok) { window.location.reload(); } else { return r.text(); } })
            .then(function(t) { if (t && typeof t === 'string') alert('Xatolik: ' + t.slice(0, 100)); });
    });
}());
</script>
{% endblock %}
