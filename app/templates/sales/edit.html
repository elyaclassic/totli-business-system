{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    {% if error == "stock" and error_detail %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Omborda yetarli mahsulot yo'q.</strong> {{ error_detail }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    {% if error == "revert" and error_detail %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>Tasdiqni bekor qilish mumkin emas.</strong> {{ error_detail }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    <div class="row mb-3">
        <div class="col-12">
            <a href="/sales" class="btn btn-outline-secondary mb-3"><i class="bi bi-arrow-left"></i> Orqaga</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ order.number }}</h5>
                    <div>
                        {% if order.status == 'draft' %}
                        <form method="POST" action="/sales/{{ order.id }}/confirm" style="display: inline;">
                            <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('Sotuvni tasdiqlaysizmi?');">
                                <i class="bi bi-check-circle"></i> Tasdiqlash
                            </button>
                        </form>
                        {% if current_user and current_user.role == 'admin' %}
                        <form method="POST" action="/sales/delete/{{ order.id }}" style="display: inline;" onsubmit="return confirm('Sotuvni o\'chirmoqchimisiz?');">
                            <button type="submit" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i> O'chirish</button>
                        </form>
                        {% endif %}
                        {% elif order.status == 'completed' and current_user and current_user.role == 'admin' %}
                        <form method="POST" action="/sales/{{ order.id }}/revert" style="display: inline;" onsubmit="return confirm('Tasdiqni bekor qilish — ombor qoldig\'i qaytadi. Davom etasizmi?');">
                            <button type="submit" class="btn btn-warning btn-sm"><i class="bi bi-arrow-counterclockwise"></i> Tasdiqni bekor qilish</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4"><strong>Mijoz:</strong> {{ order.partner.name if order.partner else '-' }}</div>
                        <div class="col-md-4"><strong>Ombor:</strong> {{ order.warehouse.name if order.warehouse else '-' }}</div>
                        <div class="col-md-4"><strong>Narx turi:</strong> {{ order.price_type.name if order.price_type_id and order.price_type else '-' }}</div>
                    </div>
                    <h6 class="mb-3">Mahsulotlar</h6>
                    {% if order.items %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr><th>№</th><th>Mahsulot</th><th>Miqdor</th><th>Narx</th><th>Summa</th>{% if order.status == 'draft' %}<th></th>{% endif %}</tr>
                            </thead>
                            <tbody>
                                {% for item in order.items %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ item.product.name if item.product else '-' }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>{{ "{:,.0f}".format(item.price) }} so'm</td>
                                    <td><strong>{{ "{:,.0f}".format(item.total) }} so'm</strong></td>
                                    {% if order.status == 'draft' %}
                                    <td>
                                        <form method="POST" action="/sales/{{ order.id }}/delete-item/{{ item.id }}" style="display:inline;" onsubmit="return confirm('Ushbu qatorni o\'chirmoqchimisiz?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                                        </form>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="4" class="text-end">Jami:</th>
                                    <th colspan="2"><strong>{{ "{:,.0f}".format(order.total or 0) }} so'm</strong></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">Hozircha mahsulotlar qo'shilmagan. {% if order.status == 'draft' %}O'ng tomondan qo'shing.{% endif %}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if order.status == 'draft' %}
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header"><h6 class="mb-0">Mahsulot qo'shish</h6></div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Mahsulot</label>
                        <select class="form-select" id="editAddProductId">
                            <option value="">Tanlang...</option>
                            {% for product in products %}
                            {% set pr = product_prices_by_type.get(product.id) if product_prices_by_type is defined else none %}
                            {% set disp = (pr if (pr is not none and pr > 0) else (product.sale_price or 0)) %}
                            <option value="{{ product.id }}" data-name="{{ product.name|e }}" data-price="{{ disp }}">{{ product.name }} — {{ "{:,.0f}".format(disp) }} so'm</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Miqdor</label>
                        <input type="number" class="form-control" id="editAddQuantity" step="0.01" min="0" value="1">
                    </div>
                    <button type="button" class="btn btn-primary w-100" id="editBtnAddToCart"><i class="bi bi-plus-circle"></i> Savatga qo'shish</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-basket"></i> Savat</span>
                </div>
                <div class="card-body">
                    <form id="editAddItemsForm" method="POST" action="/sales/{{ order.id }}/add-items">
                        <div id="editCartHiddenInputs"></div>
                        <div class="table-responsive mb-3">
                            <table class="table table-sm mb-0" id="editCartTable">
                                <thead><tr><th>Mahsulot</th><th>Miqdor</th><th>Summa</th><th></th></tr></thead>
                                <tbody id="editCartTableBody"></tbody>
                            </table>
                        </div>
                        <p class="text-muted small text-center mb-2" id="editCartEmptyMsg">Savat bo'sh. Yuqoridan mahsulot tanlab «Savatga qo'shish» bosing.</p>
                        <button type="submit" class="btn btn-success w-100" id="editBtnSubmitAll" disabled><i class="bi bi-check-lg"></i> Barchasini buyurtmaga qo'shish</button>
                    </form>
                </div>
            </div>
        </div>
        <script>
        (function() {
            var form = document.getElementById('editAddItemsForm');
            var cartHidden = document.getElementById('editCartHiddenInputs');
            var addProductId = document.getElementById('editAddProductId');
            var addQuantity = document.getElementById('editAddQuantity');
            var btnAdd = document.getElementById('editBtnAddToCart');
            var cartBody = document.getElementById('editCartTableBody');
            var cartEmptyMsg = document.getElementById('editCartEmptyMsg');
            var btnSubmitAll = document.getElementById('editBtnSubmitAll');
            var cart = [];

            function addToCart(productId, productName, price, quantity) {
                if (!productId || quantity <= 0) return;
                price = parseFloat(price) || 0;
                quantity = parseFloat(quantity) || 0;
                var sum = price * quantity;
                cart.push({ productId: productId, productName: productName, price: price, quantity: quantity, sum: sum });
                renderCart();
            }

            function removeFromCart(index) {
                cart.splice(index, 1);
                renderCart();
            }

            function renderCart() {
                cartBody.innerHTML = '';
                cartHidden.innerHTML = '';
                cart.forEach(function(item, i) {
                    var tr = document.createElement('tr');
                    tr.innerHTML = '<td>' + (item.productName || '') + '</td><td>' + item.quantity + '</td><td>' + (item.sum || 0).toLocaleString('ru-RU') + ' so\'m</td><td><button type="button" class="btn btn-sm btn-outline-danger" data-index="' + i + '"><i class="bi bi-trash"></i></button></td>';
                    cartBody.appendChild(tr);
                    var h1 = document.createElement('input');
                    h1.type = 'hidden';
                    h1.name = 'product_id';
                    h1.value = item.productId;
                    cartHidden.appendChild(h1);
                    var h2 = document.createElement('input');
                    h2.type = 'hidden';
                    h2.name = 'quantity';
                    h2.value = item.quantity;
                    cartHidden.appendChild(h2);
                });
                cartBody.querySelectorAll('button[data-index]').forEach(function(btn) {
                    btn.addEventListener('click', function() { removeFromCart(parseInt(this.getAttribute('data-index'), 10)); });
                });
                cartEmptyMsg.style.display = cart.length ? 'none' : 'block';
                if (btnSubmitAll) btnSubmitAll.disabled = cart.length === 0;
            }

            if (btnAdd) {
                btnAdd.addEventListener('click', function() {
                    var opt = addProductId && addProductId.options[addProductId.selectedIndex];
                    if (!opt || !opt.value) { alert('Mahsulotni tanlang'); return; }
                    var qty = parseFloat(addQuantity && addQuantity.value) || 0;
                    if (qty <= 0) { alert('Miqdorni kiriting'); return; }
                    addToCart(opt.value, opt.getAttribute('data-name'), opt.getAttribute('data-price'), qty);
                    if (addQuantity) addQuantity.value = '1';
                });
            }
        })();
        </script>
        {% endif %}
    </div>
</div>
{% endblock %}
