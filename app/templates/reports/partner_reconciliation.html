{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-arrow-left-right"></i> Kontragentlar hisob-kitobini solishtirish</h4>
    <a href="/reports" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Hisobotlar</a>
</div>

<div class="card mb-4">
    <div class="card-header bg-light">
        <i class="bi bi-funnel"></i> Filtr
    </div>
    <div class="card-body">
        <form method="get" action="/reports/partner-reconciliation" class="row g-3 align-items-end" id="reconciliationForm">
            <div class="col-md-4 position-relative">
                <label class="form-label">Kontragent <span class="text-danger">*</span></label>
                <input type="hidden" name="partner_id" id="partnerId" value="{{ partner_id or '' }}" required>
                <input type="text" class="form-control" id="partnerSearch" autocomplete="off"
                       placeholder="Nomini yoki kodini yozib qidiring..."
                       value="{% if partner %}{{ partner.name }}{% if partner.code %} ({{ partner.code }}){% endif %}{% endif %}">
                <div class="list-group position-absolute top-100 start-0 end-0 mt-1 shadow-sm border rounded" id="partnerDropdown" style="z-index: 1050; max-height: 280px; overflow-y: auto; display: none;"></div>
            </div>
            <div class="col-md-2">
                <label class="form-label">Boshlanish</label>
                <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Tugash</label>
                <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i> Ko'rsatish</button>
            </div>
        </form>
    </div>
</div>

{% if partner %}
<div class="card mb-3">
    <div class="card-body py-2">
        <div class="row g-3 text-center">
            <div class="col-6 col-md-3">
                <span class="text-muted small d-block">Davomiy qoldiq (oldingi)</span>
                <strong class="{% if opening_balance > 0 %}text-danger{% elif opening_balance < 0 %}text-success{% else %}text-muted{% endif %}">
                    {{ "{:,.0f}".format(opening_balance) }} so'm
                </strong>
            </div>
            <div class="col-6 col-md-3">
                <span class="text-muted small d-block">Davr debet</span>
                <strong>{{ "{:,.0f}".format(total_debit) }}</strong>
            </div>
            <div class="col-6 col-md-3">
                <span class="text-muted small d-block">Davr kredit</span>
                <strong>{{ "{:,.0f}".format(total_credit) }}</strong>
            </div>
            <div class="col-6 col-md-3">
                <span class="text-muted small d-block">Yakuniy qoldiq</span>
                <strong class="{% if closing_balance > 0 %}text-danger{% elif closing_balance < 0 %}text-success{% else %}text-muted{% endif %}">
                    {{ "{:,.0f}".format(closing_balance) }} so'm
                </strong>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-table"></i> Harakatlar — {{ partner.name }}</span>
        <a href="/reports/partner-reconciliation/export?partner_id={{ partner.id }}&date_from={{ date_from }}&date_to={{ date_to }}" class="btn btn-success btn-sm">
            <i class="bi bi-file-earmark-excel"></i> Excel
        </a>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Sana</th>
                        <th>Hujjat turi</th>
                        <th>Hujjat raqami</th>
                        <th class="text-end">Debet</th>
                        <th class="text-end">Kredit</th>
                    </tr>
                </thead>
                <tbody>
                    {% if rows %}
                        {% for r in rows %}
                        <tr>
                            <td>{{ r.date.strftime('%d.%m.%Y %H:%M') if r.date else '—' }}</td>
                            <td>{{ r.doc_type }}</td>
                            <td><code>{{ r.doc_number or '—' }}</code></td>
                            <td class="text-end">{% if r.debit %}{{ "{:,.0f}".format(r.debit) }}{% else %}—{% endif %}</td>
                            <td class="text-end">{% if r.credit %}{{ "{:,.0f}".format(r.credit) }}{% else %}—{% endif %}</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-secondary fw-bold">
                            <td colspan="3" class="text-end">Jami davr:</td>
                            <td class="text-end">{{ "{:,.0f}".format(total_debit) }}</td>
                            <td class="text-end">{{ "{:,.0f}".format(total_credit) }}</td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-5">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                Tanlangan davrda harakatlar yo'q.
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<p class="small text-muted mt-2 mb-0">
    <i class="bi bi-info-circle"></i> Debet — kontragent bizga qarzdor (sotuv, biz to'lagan to'lov). Kredit — to'lov (kirim), qaytarish, xarid.
</p>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> Hisobotni ko'rish uchun kontragentni tanlang va «Ko'rsatish» tugmasini bosing.
</div>
{% endif %}

<div id="partners-data" style="display:none" aria-hidden="true">
    {% for p in partners %}
    <span data-id="{{ p.id }}" data-label="{{ (p.name ~ (' (' ~ p.code ~ ')') if p.code else p.name)|e }}"></span>
    {% endfor %}
</div>

<script>
(function() {
    var container = document.getElementById('partners-data');
    var partners = [];
    if (container) {
        var spans = container.querySelectorAll('span[data-id][data-label]');
        for (var i = 0; i < spans.length; i++) {
            partners.push({ id: parseInt(spans[i].getAttribute('data-id'), 10), label: spans[i].getAttribute('data-label') || '' });
        }
    }
    var searchInput = document.getElementById('partnerSearch');
    var hiddenId = document.getElementById('partnerId');
    var dropdown = document.getElementById('partnerDropdown');
    if (!searchInput || !hiddenId || !dropdown) return;

    function showDropdown(items) {
        dropdown.innerHTML = '';
        if (items.length === 0) {
            dropdown.style.display = 'none';
            return;
        }
        items.forEach(function(p) {
            var a = document.createElement('a');
            a.href = '#';
            a.className = 'list-group-item list-group-item-action';
            a.textContent = p.label;
            a.dataset.id = String(p.id);
            a.dataset.label = p.label;
            a.addEventListener('click', function(e) {
                e.preventDefault();
                hiddenId.value = this.dataset.id;
                searchInput.value = this.dataset.label;
                dropdown.style.display = 'none';
            });
            dropdown.appendChild(a);
        });
        dropdown.style.display = 'block';
    }

    function filterPartners(q) {
        q = (q || '').trim().toLowerCase();
        if (q.length === 0) return partners.slice(0, 50);
        return partners.filter(function(p) {
            return p.label.toLowerCase().indexOf(q) !== -1;
        }).slice(0, 50);
    }

    searchInput.addEventListener('input', function() {
        if (this.value.trim() === '' && hiddenId.value) hiddenId.value = '';
        showDropdown(filterPartners(this.value));
    });
    searchInput.addEventListener('focus', function() {
        showDropdown(filterPartners(this.value));
    });
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') { dropdown.style.display = 'none'; }
    });

    document.addEventListener('click', function(e) {
        if (dropdown.style.display === 'block' && !searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    var form = document.getElementById('reconciliationForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!hiddenId.value || hiddenId.value === '') {
                e.preventDefault();
                searchInput.focus();
                searchInput.placeholder = 'Kontragentni ro\'yxatdan tanlang yoki qidiring...';
                showDropdown(partners.length ? partners.slice(0, 50) : []);
                return false;
            }
        });
    }
})();
</script>
{% endblock %}
