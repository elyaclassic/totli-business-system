{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="bi bi-bank"></i> Kassadan kassaga o'tkazish {% if transfer %}{{ transfer.number }}{% else %}(yaratish){% endif %}</h5>
        <a href="/cash/transfers" class="btn btn-outline-secondary btn-sm">Ro'yxat</a>
    </div>
    {% if request.query_params.get('sent') == '1' %}
    <div class="alert alert-success alert-dismissible fade show py-2 small" role="alert">
        <i class="bi bi-check-circle"></i> Hujjat yuborildi. Qabul qiluvchi kassa tasdiqlashi kerak.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    {% if request.query_params.get('confirmed') == '1' %}
    <div class="alert alert-success alert-dismissible fade show py-2 small" role="alert">
        <i class="bi bi-check-circle"></i> Hujjat tasdiqlandi. Pul qabul qiluvchi kassaga o'tkazildi.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    {% if request.query_params.get('reverted') == '1' %}
    <div class="alert alert-warning alert-dismissible fade show py-2 small" role="alert">
        Tasdiq bekor qilindi.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    {% if request.query_params.get('error') %}
    <div class="alert alert-danger alert-dismissible fade show py-2 small" role="alert">
        {{ request.query_params.get('error') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-body">
            {% if not transfer %}
            <form method="post" action="/cash/transfers/create" id="cashTransferForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token_from_request(request) }}">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Qayerdan (kassa) *</label>
                        <select name="from_cash_id" id="from_cash_id" class="form-select" required>
                            <option value="">— Tanlang —</option>
                            {% for c in cash_registers %}
                            <option value="{{ c.id }}">{{ c.name }} ({{ "{:,.0f}".format(c.balance or 0) }} so'm)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Qayerga (kassa) *</label>
                        <select name="to_cash_id" id="to_cash_id" class="form-select" required>
                            <option value="">— Tanlang —</option>
                            {% for c in cash_registers %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                            {% endfor %}
                        </select>
                        <div id="sameCashWarn" class="text-danger small mt-1" style="display: none;"><i class="bi bi-exclamation-triangle"></i> Qayerdan va qayerga kassa bir xil bo'lmasin.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Summa (so'm) *</label>
                        <input type="number" name="amount" class="form-control" step="0.01" min="0.01" required placeholder="0">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Izoh</label>
                        <input type="text" name="note" class="form-control" placeholder="Izoh">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-success" id="btnCreateTransfer"><i class="bi bi-plus-circle me-1"></i>Yaratish</button>
                        <a href="/cash/transfers" class="btn btn-outline-secondary ms-2">Bekor qilish</a>
                    </div>
                </div>
            </form>
            <script>
            (function() {
                var form = document.getElementById('cashTransferForm');
                var fromSel = document.getElementById('from_cash_id');
                var toSel = document.getElementById('to_cash_id');
                var warn = document.getElementById('sameCashWarn');
                var btn = document.getElementById('btnCreateTransfer');
                function checkSame() {
                    var from = (fromSel && fromSel.value) || '';
                    var to = (toSel && toSel.value) || '';
                    var same = from && to && from === to;
                    if (warn) warn.style.display = same ? 'block' : 'none';
                    if (btn) btn.disabled = !!same;
                    return !same;
                }
                if (fromSel) fromSel.addEventListener('change', checkSame);
                if (toSel) toSel.addEventListener('change', checkSame);
                if (form) form.addEventListener('submit', function(e) {
                    if (!checkSame()) {
                        e.preventDefault();
                        return false;
                    }
                });
                checkSame();
            })();
            </script>
            {% else %}
            <dl class="row mb-0">
                <dt class="col-sm-3">Hujjat №</dt>
                <dd class="col-sm-9">{{ transfer.number }}</dd>
                <dt class="col-sm-3">Sana</dt>
                <dd class="col-sm-9">{{ transfer.date.strftime('%d.%m.%Y %H:%M') if transfer.date else '—' }}</dd>
                <dt class="col-sm-3">Holat</dt>
                <dd class="col-sm-9">
                    {% if transfer.status == 'draft' %}
                    <span class="badge bg-warning text-dark">Qoralama</span>
                    {% elif transfer.status == 'pending_approval' %}
                    <span class="badge bg-primary">Tasdiqlash kutilmoqda</span>
                    {% elif transfer.status == 'confirmed' %}
                    <span class="badge bg-success">Tasdiqlangan</span>
                    {% else %}
                    <span class="badge bg-secondary">{{ transfer.status }}</span>
                    {% endif %}
                </dd>
                <dt class="col-sm-3">Qayerdan</dt>
                <dd class="col-sm-9">{{ transfer.from_cash.name if transfer.from_cash else '—' }}</dd>
                <dt class="col-sm-3">Qayerga</dt>
                <dd class="col-sm-9">{{ transfer.to_cash.name if transfer.to_cash else '—' }}</dd>
                <dt class="col-sm-3">Summa</dt>
                <dd class="col-sm-9 fw-bold">{{ "{:,.0f}".format(transfer.amount or 0) }} so'm</dd>
                <dt class="col-sm-3">Jo'natuvchi</dt>
                <dd class="col-sm-9">{{ transfer.user.full_name or transfer.user.username if transfer.user else '—' }}</dd>
                {% if transfer.approved_by %}
                <dt class="col-sm-3">Tasdiqlagan</dt>
                <dd class="col-sm-9">{{ transfer.approved_by.full_name or transfer.approved_by.username }}{% if transfer.approved_at %} — {{ transfer.approved_at.strftime('%d.%m.%Y %H:%M') }}{% endif %}</dd>
                {% endif %}
                {% if transfer.note %}
                <dt class="col-sm-3">Izoh</dt>
                <dd class="col-sm-9">{{ transfer.note }}</dd>
                {% endif %}
            </dl>
            <div class="mt-4 pt-3 border-top">
                {% if transfer.status == 'draft' %}
                <form method="post" action="/cash/transfers/{{ transfer.id }}/send" class="d-inline" onsubmit="return confirm('Yuborish — hujjat qabul qiluvchi kassa tasdiqlashiga yuboriladi. Davom etasizmi?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token_from_request(request) }}">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-send me-1"></i>Yuborish</button>
                </form>
                <form method="post" action="/cash/transfers/{{ transfer.id }}/delete" class="d-inline ms-2" onsubmit="return confirm('Hujjatni o\'chirmoqchimisiz?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token_from_request(request) }}">
                    <button type="submit" class="btn btn-outline-danger btn-sm">O'chirish</button>
                </form>
                {% elif transfer.status == 'pending_approval' %}
                <form method="post" action="/cash/transfers/{{ transfer.id }}/confirm" class="d-inline" onsubmit="return confirm('Pulni qabul qildingizmi? Tasdiqlash — jo\'natuvchi kassadan ayiriladi, sizning kassangizga qo\'shiladi.');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token_from_request(request) }}">
                    <button type="submit" class="btn btn-success"><i class="bi bi-check-lg me-1"></i>Tasdiqlash (qabul qilish)</button>
                </form>
                {% elif transfer.status == 'confirmed' and current_user and current_user.role == 'admin' %}
                <form method="post" action="/cash/transfers/{{ transfer.id }}/revert" class="d-inline" onsubmit="return confirm('Tasdiqni bekor qilish — balanslar qaytadi. Faqat admin. Davom etasizmi?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token_from_request(request) }}">
                    <button type="submit" class="btn btn-outline-warning btn-sm"><i class="bi bi-arrow-counterclockwise me-1"></i>Tasdiqni bekor qilish</button>
                </form>
                {% endif %}
                <a href="/cash/transfers" class="btn btn-outline-secondary ms-2">Ro'yxatga</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
