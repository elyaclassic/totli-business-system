{% extends "base.html" %}

{% block content %}
<style>
.form-1c-list { max-width: 100%; }
.form-1c-list .toolbar { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.form-1c-list .table-1c { font-size: 13px; }
.form-1c-list .table-1c th { background: #e9ecef; font-weight: 600; white-space: nowrap; }
.form-1c-list .table-1c td, .form-1c-list .table-1c th { padding: 6px 10px; vertical-align: middle; }
.form-1c-list .badge-draft { background: #ffc107; color: #000; }
.form-1c-list .badge-pending_approval { background: #0d6efd; color: #fff; }
.form-1c-list .badge-confirmed { background: #198754; color: #fff; }
</style>

<div class="container-fluid">
    {% if request.query_params.get('reverted') == '1' %}
    <div class="alert alert-success alert-dismissible fade show py-2 small" role="alert">
        <i class="bi bi-check-circle"></i> Tasdiq bekor qilindi.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    {% if request.query_params.get('deleted') == '1' %}
    <div class="alert alert-success alert-dismissible fade show py-2 small" role="alert">
        <i class="bi bi-check-circle"></i> Hujjat o'chirildi.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    {% if request.query_params.get('saved') == '1' %}
    <div class="alert alert-success alert-dismissible fade show py-2 small" role="alert">
        <i class="bi bi-check-circle"></i> Hujjat saqlandi.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    {% if error_message %}
    <div class="alert alert-danger alert-dismissible fade show py-2 small" role="alert">
        {{ error_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Ombordan omborga o'tkazish</h5>
        <a href="/warehouse/transfers/new" class="btn btn-success btn-sm">
            <i class="bi bi-plus-lg"></i> Yaratish
        </a>
    </div>

    <div class="form-1c-list bg-white border rounded p-2">
        <div class="toolbar">
            <a href="/warehouse/transfers/new" class="btn btn-success btn-sm"><i class="bi bi-plus"></i> Yaratish</a>
            <a href="/warehouse" class="btn btn-outline-secondary btn-sm">Orqaga</a>
        </div>
        <div class="table-responsive">
            <table class="table table-1c table-hover table-bordered mb-0">
                <thead>
                    <tr>
                        <th>№</th>
                        <th>Sana</th>
                        <th>Hujjat holati</th>
                        <th>Ombordan</th>
                        <th>Omborga</th>
                        <th>Qatorlar</th>
                        <th>Yaratgan</th>
                        <th>Tasdiqlagan</th>
                        <th>Amal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in transfers %}
                    <tr>
                        <td><a href="/warehouse/transfers/{{ t.id }}">{{ t.number }}</a></td>
                        <td>{{ t.date.strftime('%d.%m.%Y %H:%M') if t.date else '—' }}</td>
                        <td>
                            {% if t.status == 'draft' %}
                            <span class="badge badge-draft">Qoralama</span>
                            {% elif t.status == 'pending_approval' %}
                            <span class="badge badge-pending_approval">Tasdiqlash kutilmoqda</span>
                            {% elif t.status == 'confirmed' %}
                            <span class="badge badge-confirmed">Tasdiqlangan</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ t.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ t.from_warehouse.name if t.from_warehouse else '—' }}
                            {% if t.from_warehouse and t.from_warehouse.department %}
                            <br><small class="text-muted">({{ t.from_warehouse.department.name }})</small>
                            {% endif %}
                        </td>
                        <td>
                            {{ t.to_warehouse.name if t.to_warehouse else '—' }}
                            {% if t.to_warehouse and t.to_warehouse.department %}
                            <br><small class="text-muted">({{ t.to_warehouse.department.name }})</small>
                            {% endif %}
                        </td>
                        <td>{{ t.items|length }} ta</td>
                        <td>{{ t.user.full_name if t.user else t.user_id }}</td>
                        <td>
                            {% if t.approved_by %}
                            {{ t.approved_by.full_name }}
                            {% if t.approved_at %}
                            <br><small class="text-muted">{{ t.approved_at.strftime('%d.%m.%Y %H:%M') }}</small>
                            {% endif %}
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="/warehouse/transfers/{{ t.id }}" class="btn btn-outline-primary btn-sm">Ochish</a>
                            {% if t.status == 'pending_approval' %}
                            {# Bo'lim foydalanuvchisi tasdiqlashi mumkin #}
                            <form method="post" action="/warehouse/transfers/{{ t.id }}/confirm" class="d-inline" onsubmit="return confirm('Hujjatni tasdiqlash — ombordagi qoldiqlar o\'zgaradi. Davom etasizmi?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token_from_request(request) }}">
                                <button type="submit" class="btn btn-success btn-sm" title="Tasdiqlash"><i class="bi bi-check-lg"></i> Tasdiqlash</button>
                            </form>
                            {% endif %}
                            {% if t.status == 'confirmed' and current_user and current_user.role == 'admin' %}
                            <form method="post" action="/warehouse/transfers/{{ t.id }}/revert" class="d-inline" onsubmit="return confirm('Tasdiqni bekor qilish — ombordagi harakat teskari qilinadi. Davom etasizmi?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token_from_request(request) }}">
                                <button type="submit" class="btn btn-outline-warning btn-sm" title="Tasdiqlashni bekor qilish"><i class="bi bi-arrow-counterclockwise"></i></button>
                            </form>
                            {% endif %}
                            {% if current_user and current_user.role == 'admin' and t.status != 'confirmed' %}
                            <form method="post" action="/warehouse/transfers/{{ t.id }}/delete" class="d-inline" onsubmit="return confirm('Hujjatni butunlay o\'chirishni xohlaysizmi?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token_from_request(request) }}">
                                <button type="submit" class="btn btn-outline-danger btn-sm" title="O'chirish"><i class="bi bi-trash"></i></button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">Hujjatlar yo'q. «Yaratish» tugmasini bosing.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
(function() {
    var u = new URL(window.location.href);
    if (u.searchParams.get('deleted') === '1' || u.searchParams.get('reverted') === '1' || u.searchParams.get('saved') === '1') {
        u.searchParams.delete('deleted');
        u.searchParams.delete('reverted');
        u.searchParams.delete('saved');
        var cleanUrl = u.pathname + (u.search ? u.search : '');
        if (history.replaceState) {
            history.replaceState(null, '', cleanUrl);
        }
    }
})();
</script>
{% endblock %}
