{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h4><i class="bi bi-currency-exchange"></i> Narxni o'rnatish</h4>
                <div class="d-flex gap-2">
                    <a href="/info/prices/history" class="btn btn-outline-secondary btn-sm"><i class="bi bi-clock-history"></i> Narx o'zgarishlari tarixi</a>
                    <a href="/info" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Ma'lumotnomalar</a>
                </div>
            </div>
            <p class="text-muted mb-0 small">Mahsulot tannarxi (sotib olish) va har bir <strong>narx turi</strong> bo'yicha sotuv narxini shu yerdan o'rnating. Savdo vaqtida narx turini tanlaysiz. <strong>Tannarx</strong> avtomatik to'ldiriladi: tovar kirimi yoki qoldiq hujjatida qo'yilgan tannarxdan olinadi. Har bir saqlash <a href="/info/prices/history">hujjat sifatida tarixda</a> qayd etiladi (avvalgi va yangi narx).</p>
        </div>
    </div>

    {% if price_types %}
    <div class="card mb-3">
        <div class="card-body py-2">
            <label class="form-label me-2 mb-0">Narx turi:</label>
            <div class="d-flex flex-wrap gap-2">
                {% for pt in price_types %}
                <a href="/info/prices?price_type_id={{ pt.id }}" class="btn btn-sm {% if current_price_type_id == pt.id %}btn-primary{% else %}btn-outline-secondary{% endif %}">{{ pt.name }}</a>
                {% endfor %}
            </div>
            <small class="text-muted">Narx turlarini <a href="/info/price-types">bu yerdan</a> boshqaring.</small>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Mahsulot</th>
                            <th>Turi</th>
                            <th>O'lchov</th>
                            <th>Tannarx (so'm)</th>
                            <th>Sotuv narxi (so'm) {% if current_price_type_id %}<small class="text-muted">— tanlangan narx turi</small>{% endif %}</th>
                            <th></th>
                        </tr>
                    </thead>
                <tbody>
                    {% if products %}
                    {% for product in products %}
                    {% set sale_price_val = product_prices_by_type.get(product.id) if product_prices_by_type is defined else product.sale_price %}
                    {% if sale_price_val is none %}{% set sale_price_val = product.sale_price %}{% endif %}
                    {% set tannarx_val = (product_tannarx.get(product.id) if product_tannarx is defined else none) or product.purchase_price or 0 %}
                    {% set _uc = (product.unit.code or '')|lower if product.unit else '' %}
                    {% set _is_dona = _uc in ['dona', 'pc', 'pcs', 'ta', 'шт'] %}
                    {% set sale_fmt = "%.0f"|format(sale_price_val or 0) if _is_dona else "%.2f"|format(sale_price_val or 0) %}
                    {% set sale_step = "1" if _is_dona else "0.01" %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            <strong>{{ product.name }}</strong>
                            {% if product.barcode %}<br><small class="text-muted"><code>{{ product.barcode }}</code></small>{% endif %}
                        </td>
                        <td>
                            {% if product.type == 'tayyor' %}Tayyor{% elif product.type == 'yarim_tayyor' %}Yarim tayyor{% elif product.type == 'hom_ashyo' %}Xom ashyo{% else %}-{% endif %}
                        </td>
                        <td><small class="text-muted">{{ product.unit.code if product.unit else '-' }}</small></td>
                        <td>{{ "{:,.2f}".format(tannarx_val or 0) }} <small class="text-muted">(kirim/qoldiq)</small></td>
                        <td>
                            <form method="post" action="/info/prices/edit/{{ product.id }}" class="d-inline-flex align-items-center gap-1" style="max-width:180px">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token_from_request(request) }}">
                                <input type="hidden" name="purchase_price" value="{{ tannarx_val or 0 }}">
                                <input type="hidden" name="price_type_id" value="{{ current_price_type_id or '' }}">
                                <input type="number" name="sale_price" class="form-control form-control-sm" step="{{ sale_step }}" min="0" value="{{ sale_fmt }}" style="width:100px" title="{% if _is_dona %}Donalik — butun summa{% endif %}">
                                <button type="submit" class="btn btn-sm btn-success" title="Sotuv narxini saqlash"><i class="bi bi-check-lg"></i></button>
                            </form>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" title="Tannarx va sotuv narxini tahrirlash"
                                onclick='editPrice({{ product.id }}, {{ product.name|tojson }}, {{ tannarx_val or 0 }}, {{ sale_fmt }}, {{ current_price_type_id if current_price_type_id is not none else "null" }}, {{ "true" if _is_dona else "false" }})'>
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-5">
                            <i class="bi bi-currency-exchange fs-1 d-block mb-2"></i>
                            {% if not price_types %}
                            Avval <a href="/info/price-types">Narx turlari</a>ni qo'shing, keyin mahsulot narxlarini kiriting.
                            {% else %}
                            Mahsulotlar yo'q. <a href="/products">Tovarlar</a> bo'limida mahsulot qo'shing.
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
            </div>
        </div>
    </div>
</div>

<!-- F4 kalkulyator (sotuv narxi / tannarx maydonida F4 bosilganda) -->
<div class="modal fade" id="priceCalcModal" tabindex="-1" aria-labelledby="priceCalcModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title" id="priceCalcModalLabel"><i class="bi bi-calculator"></i> Kalkulyator <small class="text-muted">(F4)</small></h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Yopish"></button>
            </div>
            <div class="modal-body p-3">
                <input type="text" class="form-control form-control-lg mb-2 text-end font-monospace" id="priceCalcDisplay" value="0" style="font-size:1.25rem;" placeholder="0" autocomplete="off">
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="7">7</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="8">8</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="9">9</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-danger w-100 price-calc-btn" data-calc="C">C</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="4">4</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="5">5</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="6">6</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="/">/</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="1">1</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="2">2</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="3">3</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="*">*</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="0">0</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc=".">.</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="back">⌫</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="-">−</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 price-calc-btn" data-calc="+">+</button></div>
                    <div class="col-6"><button type="button" class="btn btn-secondary w-100 price-calc-btn" data-calc="=">=</button></div>
                </div>
                <p class="small text-muted mb-0">Natijani maydonga qo‘yish: <kbd>=</kbd> yoki <kbd>Enter</kbd></p>
            </div>
        </div>
    </div>
</div>

<!-- Narxni tahrirlash modal -->
<div class="modal fade" id="editPriceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editPriceForm">
                <input type="hidden" name="price_type_id" id="editPriceTypeId" value="">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Narxni tahrirlash</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3"><strong id="editProductName"></strong></p>
                    <div class="row g-3">
                        <div class="col-12 col-md-5">
                            <div class="mb-3">
                                <label class="form-label">Tannarx (so'm)</label>
                                <input type="number" name="purchase_price" id="editPurchasePrice" class="form-control" step="0.01" min="0" value="0">
                                <small class="text-muted">Bevosita yozing yoki F4 — kalkulyator.</small>
                            </div>
                            <div class="mb-0">
                                <label class="form-label">Sotuv narxi (so'm)</label>
                                <input type="number" name="sale_price" id="editSalePrice" class="form-control" step="0.01" min="0" value="0">
                                <small class="text-muted">Bevosita yozing yoki F4 — kalkulyator.</small>
                            </div>
                        </div>
                        <div class="col-12 col-md-5 d-none" id="priceCalcPanelWrap">
                            <!-- F4 kalkulyator — maydonlarning yonida -->
                            <div id="priceCalcPanel" class="border rounded p-2 d-none">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="small fw-bold"><i class="bi bi-calculator"></i> Kalkulyator (F4)</span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="priceCalcPanelClose">Yopish</button>
                                </div>
                                <input type="text" class="form-control form-control-sm mb-2 text-end font-monospace" id="priceCalcDisplayInModal" value="0" placeholder="0" autocomplete="off">
                                <div class="row g-1 mb-1" id="priceCalcButtonsInModal">
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="7">7</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="8">8</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="9">9</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-danger btn-sm w-100 price-calc-inmodal" data-calc="C">C</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="4">4</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="5">5</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="6">6</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="/">/</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="1">1</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="2">2</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="3">3</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="*">*</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="0">0</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc=".">.</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="back">⌫</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="-">−</button></div>
                                    <div class="col-3"><button type="button" class="btn btn-outline-secondary btn-sm w-100 price-calc-inmodal" data-calc="+">+</button></div>
                                    <div class="col-6"><button type="button" class="btn btn-secondary btn-sm w-100 price-calc-inmodal" data-calc="=">=</button></div>
                                </div>
                                <small class="text-muted">Hisoblab Enter bosilsa — chaqirilgan maydonga yoziladi.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg"></i> Saqlash</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
(function() {
    // Sotuv narxi / tannarx: boshidagi 0 ni olib tashlash (075000 -> 75000), . yoki , dan oldin 0 qo'shish (.56 -> 0.56)
    function normalizePriceInput(el) {
        if (!el || el.type !== 'number' && el.type !== 'text') return;
        var v = (el.value || '').toString().trim().replace(',', '.');
        if (v === '' || v === '.') return;
        if (/^\.\d/.test(v)) v = '0' + v;
        if (/^0+[1-9]\d*$/.test(v)) v = v.replace(/^0+/, '');
        if (el.value !== v) el.value = v;
    }
    function onPriceInput(e) {
        var el = e.target;
        var v = (el.value || '').toString();
        if (v === '') return;
        var normalized = v.replace(',', '.');
        if (v === '.' || v === ',' || /^[.,]/.test(normalized)) { el.value = '0' + normalized.replace(',', '.'); return; }
        if (/^0+[1-9]\d*$/.test(normalized)) el.value = normalized.replace(/^0+/, '');
    }
    document.addEventListener('DOMContentLoaded', function() {
        var purchaseEl = document.getElementById('editPurchasePrice');
        var saleEl = document.getElementById('editSalePrice');
        if (purchaseEl) purchaseEl.addEventListener('input', onPriceInput);
        if (saleEl) saleEl.addEventListener('input', onPriceInput);
        document.getElementById('editPriceForm') && document.getElementById('editPriceForm').addEventListener('input', function(e) {
            if (e.target.name === 'sale_price' || e.target.name === 'purchase_price') onPriceInput(e);
        });
        document.body.addEventListener('input', function(e) {
            if (e.target.name === 'sale_price' && e.target.closest('form') && e.target.closest('form').action && e.target.closest('form').action.indexOf('/info/prices/edit') !== -1)
                onPriceInput(e);
        }, true);
    });

    window.editPrice = function(productId, productName, purchasePrice, salePrice, priceTypeId, isDona) {
        var isDonaVal = isDona === true || isDona === 'true';
        document.getElementById('editProductName').textContent = productName;
        var purchaseEl = document.getElementById('editPurchasePrice');
        var p = Number(purchasePrice);
        purchaseEl.value = (isFinite(p) ? Math.round(p * 100) / 100 : 0).toFixed(2);
        purchaseEl.step = '0.01';
        var saleEl = document.getElementById('editSalePrice');
        saleEl.value = isDonaVal ? String(Math.round(Number(salePrice))) : (Number(salePrice) || 0);
        saleEl.step = isDonaVal ? '1' : '0.01';
        document.getElementById('editPriceTypeId').value = priceTypeId || '';
        document.getElementById('editPriceForm').action = '/info/prices/edit/' + productId;
        new bootstrap.Modal(document.getElementById('editPriceModal')).show();
    };

    // F4 — narx maydonida kalkulyator (jadvalda alohida modal, tahrir modali ichida pastda panel)
    var priceCalcTargetInput = null;
    var priceCalcModalEl = document.getElementById('priceCalcModal');
    var priceCalcDisplayEl = document.getElementById('priceCalcDisplay');
    var priceCalcPanelEl = document.getElementById('priceCalcPanel');
    var priceCalcPanelWrapEl = document.getElementById('priceCalcPanelWrap');
    var priceCalcDisplayInModalEl = document.getElementById('priceCalcDisplayInModal');

    function isPriceInput(el) {
        if (!el || el.tagName !== 'INPUT') return false;
        return el.name === 'sale_price' || el.name === 'purchase_price' ||
            el.id === 'editSalePrice' || el.id === 'editPurchasePrice';
    }

    function isEditModalPriceInput(el) {
        return el && (el.id === 'editSalePrice' || el.id === 'editPurchasePrice');
    }

    function getActiveCalcDisplay() {
        if (priceCalcPanelEl && !priceCalcPanelEl.classList.contains('d-none') && priceCalcDisplayInModalEl)
            return priceCalcDisplayInModalEl;
        return priceCalcDisplayEl;
    }

    function openPriceCalculator(inputEl) {
        priceCalcTargetInput = inputEl;
        var cur = (inputEl && inputEl.value) ? String(inputEl.value).replace(/\s/g, '') : '';
        if (cur === '') cur = '0';
        if (isEditModalPriceInput(inputEl)) {
            if (priceCalcDisplayInModalEl) {
                var num = parseFloat(String(cur).replace(',', '.')) || 0;
                priceCalcDisplayInModalEl.value = num === 0 ? '0' : String(cur).replace(',', '.');
            }
            if (priceCalcPanelWrapEl) priceCalcPanelWrapEl.classList.remove('d-none');
            if (priceCalcPanelEl) priceCalcPanelEl.classList.remove('d-none');
            priceCalcDisplayInModalEl && priceCalcDisplayInModalEl.focus();
        } else {
            if (priceCalcDisplayEl) priceCalcDisplayEl.value = cur;
            priceCalcModalEl && !priceCalcModalEl.classList.contains('show') && new bootstrap.Modal(priceCalcModalEl).show();
            priceCalcDisplayEl && priceCalcDisplayEl.focus();
        }
    }

    function closePriceCalcPanel() {
        if (priceCalcPanelEl) priceCalcPanelEl.classList.add('d-none');
        if (priceCalcPanelWrapEl) priceCalcPanelWrapEl.classList.add('d-none');
        priceCalcTargetInput = null;
    }

    function safeEval(expr) {
        var s = String(expr).replace(/\s/g, '').replace(/×/g, '*').replace(/÷/g, '/').replace(/−/g, '-');
        if (!/^[\d.+\-*/()\s]+$/.test(s)) return NaN;
        try {
            var n = new Function('return (' + s + ')')();
            return typeof n === 'number' && isFinite(n) ? n : NaN;
        } catch (e) { return NaN; }
    }

    function applyPriceCalcResult() {
        if (!priceCalcTargetInput) return;
        var displayEl = getActiveCalcDisplay();
        if (!displayEl) return;
        var expr = (displayEl.value || '').replace(/\s/g, '');
        if (expr === '' || expr === '.') expr = '0';
        var num = safeEval(expr);
        if (!isNaN(num) && num >= 0) {
            var step = priceCalcTargetInput.getAttribute('step');
            var isInt = step === '1';
            priceCalcTargetInput.value = isInt ? String(Math.round(num)) : (Math.round(num * 100) / 100).toFixed(2);
            priceCalcTargetInput.dispatchEvent(new Event('input', { bubbles: true }));
            priceCalcTargetInput.focus();
        }
        if (priceCalcPanelEl && !priceCalcPanelEl.classList.contains('d-none')) closePriceCalcPanel();
        if (priceCalcModalEl && priceCalcModalEl.classList.contains('show'))
            bootstrap.Modal.getInstance(priceCalcModalEl) && bootstrap.Modal.getInstance(priceCalcModalEl).hide();
        priceCalcTargetInput = null;
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'F4') {
            if (isPriceInput(document.activeElement)) {
                e.preventDefault();
                openPriceCalculator(document.activeElement);
                return;
            }
            if (priceCalcPanelEl && !priceCalcPanelEl.classList.contains('d-none') && (e.target === priceCalcDisplayInModalEl || priceCalcPanelEl.contains(e.target))) {
                e.preventDefault();
                applyPriceCalcResult();
                return;
            }
            if (priceCalcModalEl && priceCalcModalEl.classList.contains('show')) {
                e.preventDefault();
                if (e.target === priceCalcDisplayEl || priceCalcModalEl.contains(e.target)) applyPriceCalcResult();
                return;
            }
        }
        if (e.key === 'Enter') {
            if (priceCalcPanelEl && !priceCalcPanelEl.classList.contains('d-none') && (e.target === priceCalcDisplayInModalEl || priceCalcPanelEl.contains(e.target))) {
                e.preventDefault();
                applyPriceCalcResult();
                return;
            }
            if (priceCalcModalEl && priceCalcModalEl.classList.contains('show') && (e.target === priceCalcDisplayEl || priceCalcModalEl.contains(e.target))) {
                e.preventDefault();
                applyPriceCalcResult();
            }
        }
        if (e.key === 'Escape' && priceCalcPanelEl && !priceCalcPanelEl.classList.contains('d-none') && priceCalcPanelEl.contains(e.target)) {
            closePriceCalcPanel();
        }
    }, true);

    if (priceCalcModalEl) {
        priceCalcModalEl.addEventListener('shown.bs.modal', function() {
            if (priceCalcDisplayEl) priceCalcDisplayEl.value = priceCalcDisplayEl.value || '0';
            priceCalcDisplayEl && priceCalcDisplayEl.focus();
        });
        priceCalcModalEl.addEventListener('hidden.bs.modal', function() {
            priceCalcTargetInput = null;
        });
    }

    if (priceCalcDisplayEl) {
        priceCalcDisplayEl.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); applyPriceCalcResult(); return; }
            if (e.key === 'Escape') { bootstrap.Modal.getInstance(priceCalcModalEl) && bootstrap.Modal.getInstance(priceCalcModalEl).hide(); return; }
            if (e.key === 'Backspace') return;
            if (/[\d.+*/\-]/.test(e.key) || e.key === ',') return;
            e.preventDefault();
        });
        priceCalcDisplayEl.addEventListener('input', function() {
            this.value = this.value.replace(',', '.').replace(/[^\d.+*/\-\s]/g, '');
        });
    }

    if (priceCalcDisplayInModalEl) {
        priceCalcDisplayInModalEl.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); applyPriceCalcResult(); return; }
            if (e.key === 'Escape') { closePriceCalcPanel(); return; }
            if (e.key === 'Backspace') return;
            if (/[\d.+*/\-]/.test(e.key) || e.key === ',') return;
            e.preventDefault();
        });
        priceCalcDisplayInModalEl.addEventListener('input', function() {
            this.value = this.value.replace(',', '.').replace(/[^\d.+*/\-\s]/g, '');
        });
    }

    document.getElementById('priceCalcPanelClose') && document.getElementById('priceCalcPanelClose').addEventListener('click', closePriceCalcPanel);

    function isCalcDisplayZero(s) {
        if (!s || s === '0') return true;
        return /^0\.?0*$/.test(String(s).trim());
    }

    function updateCalcDisplay(displayEl, v) {
        if (!displayEl) return;
        var cur = (displayEl.value || '0').toString().trim().replace(',', '.');
        if (v === 'C') { displayEl.value = '0'; return; }
        if (v === 'back') { displayEl.value = cur.length <= 1 ? '0' : cur.slice(0, -1); return; }
        if (v === '=') { applyPriceCalcResult(); return; }
        if (isCalcDisplayZero(cur)) {
            if (v >= '1' && v <= '9') { displayEl.value = v; return; }
            if (v === '0') { displayEl.value = '0'; return; }
            if (v === '.') { displayEl.value = '0.'; return; }
        }
        displayEl.value = cur + v;
    }

    document.querySelectorAll('.price-calc-btn').forEach(function(btn) {
        btn.addEventListener('click', function() { updateCalcDisplay(priceCalcDisplayEl, btn.getAttribute('data-calc')); });
    });
    document.querySelectorAll('.price-calc-inmodal').forEach(function(btn) {
        btn.addEventListener('click', function() { updateCalcDisplay(priceCalcDisplayInModalEl, btn.getAttribute('data-calc')); });
    });

    document.getElementById('editPriceModal') && document.getElementById('editPriceModal').addEventListener('show.bs.modal', function() {
        closePriceCalcPanel();
    });
})();
</script>
{% endblock %}
