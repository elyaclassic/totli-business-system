{% extends "base.html" %}

{% block content %}
{% if error == "insufficient_stock" %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>Omborda yetarli xom ashyo yo'q.</strong>
    {% if error_detail %}<br><small>{{ error_detail }}</small>{% endif %}
    Kerakli mahsulotlarni omborga kiriting.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}
{% if error == "revert" %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>Tasdiqni bekor qilish mumkin emas.</strong> {% if error_detail %}{{ error_detail }}{% endif %}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}
{% if error == "stage" %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <strong>Bosqich xatosi.</strong> {% if error_detail %}{{ error_detail }}{% endif %}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}
<div class="container-fluid">
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="bi bi-clipboard-check"></i> Ishlab chiqarish buyurtmalari</h4>
    <a href="/production/new" class="btn btn-success"><i class="bi bi-plus-circle"></i> Yaratish</a>
</div>

<!-- Filtrlar -->
<div class="card mb-3">
    <div class="card-body py-2">
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary active" onclick="filterStatus('all')">
                Barchasi ({{ productions|length }})
            </button>
            <button class="btn btn-sm btn-outline-warning" onclick="filterStatus('draft')">
                Kutilmoqda ({{ productions|selectattr('status', 'eq', 'draft')|list|length }})
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="filterStatus('in_progress')">
                Jarayonda ({{ productions|selectattr('status', 'eq', 'in_progress')|list|length }})
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="filterStatus('completed')">
                Yakunlangan ({{ productions|selectattr('status', 'eq', 'completed')|list|length }})
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="filterStatus('cancelled')">
                Bekor qilingan ({{ productions|selectattr('status', 'eq', 'cancelled')|list|length }})
            </button>
        </div>
    </div>
</div>

<!-- Jadval -->
<div class="card">
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Raqam</th>
                    <th>Sana</th>
                    <th>Retsept</th>
                    <th>Miqdor</th>
                    <th>Bosqich</th>
                    <th>Uskuna</th>
                    <th>Operator</th>
                    <th>1-ombor</th>
                    <th>2-ombor</th>
                    <th>Holat</th>
                    <th>Amallar</th>
                </tr>
            </thead>
            <tbody id="productionTable">
                {% for prod in productions %}
                <tr data-status="{{ prod.status }}">
                    <td><strong>{{ prod.number }}</strong></td>
                    <td>{{ prod.date.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td>
                        {% if prod.recipe %}
                        <a href="/production/recipes/{{ prod.recipe_id }}">{{ prod.recipe.name }}</a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {% set unit_name = (prod.recipe.product.unit.name if prod.recipe and prod.recipe.product and prod.recipe.product.unit else 'kg') %}
                        {% set qty_kg = (prod.quantity * (prod.recipe.output_quantity or 1)) if (prod.recipe and prod.recipe.output_quantity) else prod.quantity %}
                        <strong>{{ "%.2f"|format(prod.quantity) }} {{ unit_name }}</strong>
                        {% if unit_name|lower != 'kg' and prod.recipe and prod.recipe.output_quantity %}
                        <span class="text-muted small">({{ "%.2f"|format(qty_kg) }} kg)</span>
                        {% endif %}
                    </td>
                    <td>
                        {% set cur = getattr(prod, 'current_stage', 1) or 1 %}
                        {% set r_stages = (prod.recipe.stages|sort(attribute='stage_number')) if (prod.recipe and prod.recipe.stages) else [] %}
                        {% set eff_max = (r_stages|map(attribute='stage_number')|list|max) if r_stages else 2 %}
                        {% if r_stages %}
                            {% for s in r_stages %}
                                {% if s.stage_number < cur %}
                                    <span class="badge bg-success me-1" title="{{ s.name }}">{{ s.stage_number }}</span>
                                {% elif s.stage_number == cur and prod.status != 'completed' %}
                                    <span class="badge bg-primary me-1" title="{{ s.name }}">{{ s.stage_number }}</span>
                                {% elif s.stage_number == cur and prod.status == 'completed' %}
                                    <span class="badge bg-success me-1">{{ s.stage_number }}</span>
                                {% else %}
                                    <span class="badge bg-secondary me-1">{{ s.stage_number }}</span>
                                {% endif %}
                            {% endfor %}
                            <small class="d-block text-muted mt-1">
                                {% for s in r_stages %}{% if s.stage_number == cur %}{{ s.name }}{% endif %}{% endfor %}
                            </small>
                        {% else %}
                            {% set default_max = 2 %}
                            {% for sn in [1, 2] %}
                                {% if sn < cur %}
                                    <span class="badge bg-success me-1" title="{{ stage_names.get(sn, '') }}">{{ sn }}</span>
                                {% elif sn == cur and prod.status != 'completed' %}
                                    <span class="badge bg-primary me-1" title="{{ stage_names.get(sn, '') }}">{{ sn }}</span>
                                {% elif sn == cur and prod.status == 'completed' %}
                                    <span class="badge bg-success me-1">{{ sn }}</span>
                                {% else %}
                                    <span class="badge bg-secondary me-1">{{ sn }}</span>
                                {% endif %}
                            {% endfor %}
                            <small class="d-block text-muted mt-1">{{ stage_names.get(cur, '') if stage_names else '' }}</small>
                        {% endif %}
                    </td>
                    <td>{{ prod.machine.name if prod.machine else '-' }}</td>
                    <td>{{ prod.operator.full_name if prod.operator else '-' }}</td>
                    <td>
                        {% if prod.warehouse %}
                        {{ prod.warehouse.name }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {% if prod.output_warehouse %}
                        {{ prod.output_warehouse.name }}
                        {% else %}
                        {{ prod.warehouse.name if prod.warehouse else '-' }}
                        {% endif %}
                    </td>
                    <td>
                        {% if prod.status == 'completed' %}
                        <span class="badge bg-success">Yakunlandi</span>
                        {% elif prod.status == 'in_progress' %}
                        <span class="badge bg-info">Jarayonda</span>
                        {% elif prod.status == 'draft' %}
                        <span class="badge bg-warning">Kutilmoqda</span>
                        {% else %}
                        <span class="badge bg-danger">Bekor</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if prod.status == 'draft' or prod.status == 'in_progress' %}
                        <a href="/production/{{ prod.id }}/materials" class="btn btn-sm btn-outline-primary" title="Xom ashyoni tahrirlash">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <form method="POST" action="/production/{{ prod.id }}/complete-stage" style="display: inline;" class="d-inline">
                            <input type="hidden" name="stage_number" value="{{ [cur, eff_max]|min }}">
                            <select name="machine_id" class="form-select form-select-sm d-inline-block w-auto" title="Uskuna">
                                <option value="">— Uskuna —</option>
                                {% for m in machines %}<option value="{{ m.id }}">{{ m.name }}</option>{% endfor %}
                            </select>
                            <select name="operator_id" class="form-select form-select-sm d-inline-block w-auto" title="Operator">
                                <option value="">— Operator —</option>
                                {% for e in employees %}<option value="{{ e.id }}">{{ e.full_name }}</option>{% endfor %}
                            </select>
                            <button type="submit" class="btn btn-sm btn-success" title="Bosqichni yakunlash">
                                <i class="bi bi-check-lg"></i> Bosqich
                            </button>
                        </form>
                        <form method="POST" action="/production/{{ prod.id }}/complete" style="display: inline;" class="d-inline" title="Bir martada yakunlash (4 bosqichsiz)">
                            <button type="submit" class="btn btn-sm btn-outline-success">Yakunlash</button>
                        </form>
                        <form method="POST" action="/production/{{ prod.id }}/cancel" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-danger" title="Bekor qilish">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </form>
                        {% elif prod.status == 'completed' and current_user and current_user.role == 'admin' %}
                        <a href="/production/{{ prod.id }}/materials" class="btn btn-sm btn-outline-primary" title="Tahrirlash (ko'rish)">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <form method="POST" action="/production/{{ prod.id }}/revert" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-outline-warning" title="Tasdiqni bekor qilish"
                                onclick="return confirm('Tasdiqni bekor qilish — xom ashyo qaytadi, tayyor mahsulot olib tashlanadi. Davom etasizmi?');">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                        </form>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                        {% if current_user and current_user.role == 'admin' %}
                        <form method="POST" action="/production/{{ prod.id }}/delete" style="display: inline;" class="ms-1"
                            onsubmit="return confirm('Buyurtmani butunlay o\'chirishni xohlaysizmi? Bu amalni qaytarib bo\'lmaydi.');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token_from_request(request) }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="O'chirish">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="11" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1"></i><br>
                        Ishlab chiqarish buyurtmalari yo'q
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function filterStatus(status) {
    var rows = document.querySelectorAll('#productionTable tr[data-status]');
    rows.forEach(function(row) {
        if (status === 'all' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Active button
    document.querySelectorAll('.card-body .btn').forEach(function(btn) {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}
</script>
</div>
{% endblock %}
