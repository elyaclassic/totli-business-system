{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between mb-4">
    <div>
        <a href="/production" class="btn btn-outline-secondary btn-sm mb-2">
            <i class="bi bi-arrow-left"></i> Orqaga
        </a>
        <h4><i class="bi bi-plus-circle"></i> Yangi ishlab chiqarish</h4>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-gear"></i> Ishlab chiqarish ma'lumotlari
            </div>
            <div class="card-body">
                <form method="POST" action="/production/create" id="productionForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Retsept <span class="text-danger">*</span></label>
                            <select class="form-select" name="recipe_id" id="recipeSelect" required onchange="updateRecipeInfo()">
                                <option value="">Tanlang...</option>
                                {% for recipe in recipes %}
                                <option value="{{ recipe.id }}" 
                                        data-items="{{ recipe.items|length }}"
                                        data-output="{{ recipe.output_quantity }}">
                                    {{ recipe.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">1-ombor: Xom ashyo ombori <span class="text-danger">*</span></label>
                            {% set wh_list = warehouses or [] %}
                            {% if not wh_list %}
                            <div class="alert alert-warning py-2 mb-0"><small><i class="bi bi-exclamation-triangle"></i> <a href="/info/warehouses">Ma'lumotnomalar → Omborlar</a> orqali ombor qo'shing.</small></div>
                            {% endif %}
                            <select class="form-select" name="warehouse_id" required title="Xom ashyo shu ombordan olinadi" {% if not wh_list %}disabled{% endif %}>
                                <option value="">Tanlang...</option>
                                {% for wh in wh_list %}
                                <option value="{{ wh.id }}">{{ wh.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Xom ashyo shu ombordan olinadi</small>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">2-ombor: Yarim tayyor mahsulot ombori <span class="text-danger">*</span></label>
                            <select class="form-select" name="output_warehouse_id" required title="Tayyor mahsulot shu omborga yoziladi" {% if not wh_list %}disabled{% endif %}>
                                <option value="">Tanlang...</option>
                                {% for wh in wh_list %}
                                <option value="{{ wh.id }}">{{ wh.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Ishlab chiqarilgan mahsulot shu omborga jo'natiladi</small>
                        </div>
                        <div class="col-md-6"></div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Uskuna</label>
                            <select class="form-select" name="machine_id">
                                <option value="">— Tanlash —</option>
                                {% for m in machines or [] %}
                                <option value="{{ m.id }}">{{ m.name }} ({{ m.code }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Operator (xodim)</label>
                            <select class="form-select" name="operator_id">
                                <option value="">— Tanlash —</option>
                                {% for emp in employees or [] %}
                                <option value="{{ emp.id }}">{{ emp.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Ishlab chiqarish miqdori (kg) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control form-control-lg" name="quantity" 
                                   id="quantityInput" value="10" step="0.01" min="0.01" required 
                                   onchange="calculateMaterials()" title="Miqdorni o'zgartirish: F4 — kalkulyator">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Chiqish miqdori</label>
                            <div class="form-control form-control-lg bg-light" id="outputQuantity">
                                - kg
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Izoh</label>
                        <textarea class="form-control" name="note" rows="2" placeholder="Qo'shimcha ma'lumotlar..."></textarea>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-play-fill"></i> Ishlab chiqarishni boshlash
                        </button>
                        <a href="/production" class="btn btn-outline-secondary btn-lg">Bekor qilish</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Retsept ma'lumoti -->
        <div class="card" id="recipeInfoCard" style="display: none;">
            <div class="card-header">
                <i class="bi bi-journal-text"></i> Retsept ma'lumoti
            </div>
            <div class="card-body">
                <div id="recipeInfo">
                    <p class="text-muted">Retsept tanlang</p>
                </div>
            </div>
        </div>
        
        <!-- Kerakli xom ashyolar -->
        <div class="card mt-3" id="materialsCard" style="display: none;">
            <div class="card-header">
                <i class="bi bi-list-check"></i> Kerakli xom ashyolar
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush" id="materialsList">
                </ul>
            </div>
        </div>
        
        <!-- Qisqa yo'riqnoma -->
        <div class="card mt-3 border-info">
            <div class="card-body">
                <h6><i class="bi bi-info-circle text-info"></i> Yo'riqnoma</h6>
                <ol class="small mb-0">
                    <li>Retseptni tanlang</li>
                    <li>Miqdorni kiriting (kg)</li>
                    <li>Omborni tanlang</li>
                    <li>"Boshlash" tugmasini bosing</li>
                    <li>Yakunlagandan keyin "Yakunlash" bosing</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- F4 kalkulyator -->
<div class="modal fade" id="calcModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title"><i class="bi bi-calculator"></i> Kalkulyator (F4)</h6>
                <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <input type="text" class="form-control form-control-lg mb-2 text-end font-monospace" id="calcDisplay" value="0" style="font-size:1.25rem;" placeholder="Klaviaturada yozing yoki tugmalardan foydalaning" autocomplete="off" inputmode="decimal">
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-danger w-100 btn-sm" id="calcBtnC">C</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 btn-sm" id="calcBtnCE">CE</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 btn-sm" id="calcBtnBack">&larr;</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 btn-sm" disabled>/</button></div>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="7">7</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="8">8</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="9">9</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 btn-sm" disabled>*</button></div>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="4">4</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="5">5</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="6">6</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-primary w-100 btn-sm" id="calcBtnMinus">−</button></div>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="1">1</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="2">2</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="3">3</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-primary w-100 btn-sm" id="calcBtnPlus">+</button></div>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="0">0</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100" id="calcBtn00">00</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100" id="calcBtnComma">,</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-primary w-100 btn-sm" id="calcBtnEq">=</button></div>
                </div>
                <div class="row g-1">
                    <div class="col-12"><button type="button" class="btn btn-success w-100" id="calcOK">OK — qiymatni qo‘yish</button></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var calcTargetInput = null;
    var calcAcc = 0;
    var calcDisplayStr = '0';
    var calcNewEntry = false;
    var calcDisplayEl = null;

    function calcParse(s) {
        if (!s) return 0;
        var n = parseFloat(String(s).replace(',', '.')) || 0;
        return isNaN(n) ? 0 : n;
    }
    function calcFormat(n) {
        var r = Math.round(parseFloat(n) * 1e6) / 1e6;
        var s = String(r).replace('.', ',');
        return s;
    }
    function calcNorm(s) {
        s = String(s || '0').replace(',', '.').replace(/[^\d.]/g, '');
        var parts = s.split('.');
        if (parts.length > 2) s = parts[0] + '.' + parts.slice(1).join('');
        if (s === '' || s === '.') s = '0';
        if (s.indexOf('.') === 0) s = '0' + s;
        s = s.replace(/^0+(\d)/, '$1').replace(/^0+$/, '0');
        return s.replace('.', ',');
    }
    function calcUpdateDisplay() {
        if (calcDisplayEl) calcDisplayEl.value = calcDisplayStr;
    }

    function calcInput(ch) {
        if (ch === 'C') {
            calcAcc = 0;
            calcDisplayStr = '0';
            calcNewEntry = false;
            calcUpdateDisplay();
            return;
        }
        if (ch === 'CE') {
            calcDisplayStr = '0';
            calcNewEntry = false;
            calcUpdateDisplay();
            return;
        }
        if (ch === '+') {
            calcAcc = Math.round((calcAcc + calcParse(calcDisplayStr)) * 1e6) / 1e6;
            calcDisplayStr = calcFormat(calcAcc);
            calcNewEntry = true;
            calcUpdateDisplay();
            return;
        }
        if (ch === '-') {
            calcAcc = Math.round((calcAcc - calcParse(calcDisplayStr)) * 1e6) / 1e6;
            calcDisplayStr = calcFormat(calcAcc);
            calcNewEntry = true;
            calcUpdateDisplay();
            return;
        }
        if (ch === '=') {
            calcAcc = Math.round((calcAcc + calcParse(calcDisplayStr)) * 1e6) / 1e6;
            calcDisplayStr = calcFormat(calcAcc);
            calcNewEntry = true;
            calcUpdateDisplay();
            return;
        }
        if (ch === '\u2190' || ch === 'Back') {
            calcDisplayStr = calcDisplayStr.slice(0, -1) || '0';
            calcNewEntry = false;
            calcUpdateDisplay();
            return;
        }
        if (ch === '00') {
            if (calcNewEntry) { calcDisplayStr = '0'; calcNewEntry = false; }
            else if (calcDisplayStr !== '0') calcDisplayStr += '00';
            calcUpdateDisplay();
            return;
        }
        if (ch === '.' || ch === ',') {
            if (calcNewEntry) { calcDisplayStr = '0,'; calcNewEntry = false; }
            else if (calcDisplayStr.indexOf(',') === -1) calcDisplayStr += ',';
            calcUpdateDisplay();
            return;
        }
        if (/^\d$/.test(ch)) {
            if (calcNewEntry) {
                calcDisplayStr = ch === '0' ? '0' : ch;
                calcNewEntry = false;
            } else {
                if (calcDisplayStr === '0' && ch !== '0') calcDisplayStr = ch;
                else calcDisplayStr += ch;
            }
            calcUpdateDisplay();
        }
    }

    function calcBack() { calcInput('Back'); }

    window.openCalcForInput = function(inputEl) {
        if (!inputEl || (inputEl.type !== 'number' && inputEl.type !== 'text')) return;
        calcTargetInput = inputEl;
        var v = (inputEl.value || '0').toString();
        calcDisplayStr = calcNorm(v);
        calcAcc = 0;
        calcNewEntry = false;
        calcDisplayEl = document.getElementById('calcDisplay');
        calcUpdateDisplay();
        var modal = new bootstrap.Modal(document.getElementById('calcModal'));
        modal.show();
    };

    document.addEventListener('DOMContentLoaded', function() {
        calcDisplayEl = document.getElementById('calcDisplay');
        document.getElementById('calcBtnC').onclick = function() { calcInput('C'); };
        document.getElementById('calcBtnCE').onclick = function() { calcInput('CE'); };
        document.getElementById('calcBtnBack').onclick = function() { calcInput('Back'); };
        document.getElementById('calcBtnPlus').onclick = function() { calcInput('+'); };
        document.getElementById('calcBtnMinus').onclick = function() { calcInput('-'); };
        document.getElementById('calcBtnEq').onclick = function() { calcInput('='); };
        document.getElementById('calcBtn00').onclick = function() { calcInput('00'); };
        document.getElementById('calcBtnComma').onclick = function() { calcInput(','); };
        document.querySelectorAll('.calcDigit').forEach(function(btn) {
            btn.onclick = function() { calcInput(btn.getAttribute('data-digit')); };
        });
        calcDisplayEl.addEventListener('input', function() {
            calcDisplayStr = calcNorm(this.value);
            calcNewEntry = false;
            this.value = calcDisplayStr;
        });
        calcDisplayEl.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); document.getElementById('calcOK').click(); return; }
            if (e.key === 'Escape') { e.preventDefault(); bootstrap.Modal.getInstance(document.getElementById('calcModal')).hide(); return; }
            if (e.key >= '0' && e.key <= '9') { e.preventDefault(); calcInput(e.key); return; }
            if (e.key === ',' || e.key === '.') { e.preventDefault(); calcInput(','); return; }
            if (e.key === '+') { e.preventDefault(); calcInput('+'); return; }
            if (e.key === '-') { e.preventDefault(); calcInput('-'); return; }
            if (e.key === '=') { e.preventDefault(); calcInput('='); return; }
            if (e.key === 'Backspace') { e.preventDefault(); calcBack(); }
        });
        document.getElementById('calcModal').addEventListener('shown.bs.modal', function() {
            calcDisplayEl.value = calcDisplayStr;
            calcDisplayEl.select();
            setTimeout(function() {
                calcDisplayEl.focus();
                calcDisplayEl.select();
            }, 50);
        });
        document.getElementById('calcOK').addEventListener('click', function() {
            calcDisplayStr = calcNorm(calcDisplayEl.value);
            var num;
            if (!calcNewEntry && calcDisplayStr !== '' && calcDisplayStr !== '0') {
                calcAcc = Math.round((calcAcc + calcParse(calcDisplayStr)) * 1e6) / 1e6;
                num = calcAcc;
            } else {
                num = calcParse(calcDisplayStr);
            }
            if (calcTargetInput) {
                calcTargetInput.value = num;
                if (calcTargetInput.id === 'quantityInput' && typeof calculateMaterials === 'function') calculateMaterials();
                calcTargetInput.focus();
            }
            bootstrap.Modal.getInstance(document.getElementById('calcModal')).hide();
            calcTargetInput = null;
        });
        document.getElementById('productionForm').addEventListener('keydown', function(e) {
            if (e.key === 'F4' && e.target && e.target.matches('input[type="number"]')) {
                e.preventDefault();
                openCalcForInput(e.target);
            }
        });
    });
})();
</script>

<script>
var recipes = {
    {% for recipe in recipes %}
    {{ recipe.id }}: {
        name: "{{ recipe.name }}",
        output: {{ recipe.output_quantity }},
        items: [
            {% for item in recipe.items %}
            {
                name: "{{ item.product.name if item.product else 'Noma\'lum' }}",
                quantity: {{ item.quantity }},
                product_id: {{ item.product_id }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

function updateRecipeInfo() {
    var select = document.getElementById('recipeSelect');
    var recipeId = select.value;
    
    if (recipeId && recipes[recipeId]) {
        var recipe = recipes[recipeId];
        
        document.getElementById('recipeInfoCard').style.display = 'block';
        document.getElementById('materialsCard').style.display = 'block';
        
        document.getElementById('recipeInfo').innerHTML = 
            '<strong>' + recipe.name + '</strong><br>' +
            '<span class="text-muted">' + recipe.items.length + ' xom ashyo</span><br>' +
            '<span class="text-muted">Chiqish: ' + recipe.output + ' kg</span>';
        
        calculateMaterials();
    } else {
        document.getElementById('recipeInfoCard').style.display = 'none';
        document.getElementById('materialsCard').style.display = 'none';
    }
}

function calculateMaterials() {
    var recipeId = document.getElementById('recipeSelect').value;
    var quantity = parseFloat(document.getElementById('quantityInput').value) || 0;
    
    if (recipeId && recipes[recipeId]) {
        var recipe = recipes[recipeId];
        
        // Chiqish miqdori — yaxlitlanmasin, kiritilgan miqdor bo'yicha (2 xona kasr)
        var outputVal = quantity * recipe.output;
        document.getElementById('outputQuantity').textContent = 
            (Math.round(outputVal * 100) / 100).toFixed(2) + ' kg';
        
        // Xom ashyolar (editable)
        var html = '';
        recipe.items.forEach(function(item, idx) {
            var needed = (item.quantity * quantity).toFixed(2);
            html += `<li class="list-group-item d-flex align-items-center gap-2">
                <input type="hidden" name="material_product_id[]" value="${item.product_id || ''}">
                <span class="flex-grow-1">${item.name}</span>
                <input type="number" step="0.01" min="0" name="material_quantity[]" value="${needed}" class="form-control form-control-sm" style="width:90px; text-align:right;">
                <span class="ms-1">kg</span>
            </li>`;
        });
        document.getElementById('materialsList').innerHTML = html || 
            '<li class="list-group-item text-muted">Tarkib bo\'sh</li>';
    }
}
</script>
{% endblock %}
