{% extends "base.html" %}
{% block extra_css %}
<link href="/static/css/production.css" rel="stylesheet">
{% endblock %}
{% block content %}
<style>
    .recipe_search_results {
        position: fixed !important;
        z-index: 9999 !important;
        max-height: 300px !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        display: none !important;
        background: white !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 0.25rem !important;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15) !important;
    }
    .recipe_search_results.show {
        display: block !important;
    }
    .recipe_search_results .list-group-item:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }
</style>
<div class="container-fluid production-page">
<div class="page-header">
    <div>
        <a href="/production" class="btn btn-outline-secondary btn-sm mb-2">
            <i class="bi bi-arrow-left"></i> Orqaga
        </a>
        <h4><i class="bi bi-plus-circle"></i> Yangi ishlab chiqarish</h4>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-gear"></i> Ishlab chiqarish ma'lumotlari
            </div>
            <div class="card-body">
                {% if error %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{ error }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Yopish"></button>
                </div>
                {% endif %}
                <form method="POST" action="/production/create" id="productionForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Retsept <span class="text-danger">*</span></label>
                            <div class="recipe-search-wrapper" style="position: relative;">
                                <input type="text" class="form-control recipe-search-input" id="recipeSearch" 
                                    placeholder="Retsept nomini yozib qidiring..." autocomplete="off">
                                <input type="hidden" name="recipe_id" id="recipeSelect" required>
                                <div class="recipe_search_results list-group" id="recipeSearchResults" style="display: none;"></div>
                            </div>
                            <select id="recipeSelectHidden" style="display: none;" onchange="updateRecipeInfo()">
                                <option value="">Tanlang...</option>
                                {% for recipe in recipes %}
                                {% set _rname = (recipe.name or '')|lower %}
                                {% set _kg_per_unit = 0.25 if ('250gr' in _rname or '250 gr' in _rname) else (0.4 if ('400gr' in _rname or '400 gr' in _rname) else (5.0 if ('5kg' in _rname or '5 kg' in _rname) else (4.0 if ('4kg' in _rname or '4 kg' in _rname) else (3.0 if ('3kg' in _rname or '3 kg' in _rname) else (2.0 if ('2kg' in _rname or '2 kg' in _rname) else (1.0 if ('1kg' in _rname or '1 kg' in _rname) else (recipe.output_quantity or 1))))))) %}
                                <option value="{{ recipe.id }}" 
                                        data-name="{{ recipe.name|e }}"
                                        data-items="{{ recipe.items|length }}"
                                        data-output="{{ _kg_per_unit }}"
                                        data-default-warehouse="{{ recipe.default_warehouse_id or '' }}"
                                        data-default-output-warehouse="{{ recipe.default_output_warehouse_id or '' }}">
                                    {{ recipe.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">1-ombor: Xom ashyo ombori <span class="text-danger">*</span></label>
                            {% set wh_list = warehouses or [] %}
                            {% if not wh_list %}
                            <div class="alert alert-warning py-2 mb-0"><small><i class="bi bi-exclamation-triangle"></i> <a href="/info/warehouses">Ma'lumotnomalar → Omborlar</a> orqali ombor qo'shing.</small></div>
                            {% endif %}
                            <select class="form-select" name="warehouse_id" required title="Xom ashyo shu ombordan olinadi" {% if not wh_list %}disabled{% endif %}>
                                <option value="">Tanlang...</option>
                                {% for wh in wh_list %}
                                <option value="{{ wh.id }}">{{ wh.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Xom ashyo shu ombordan olinadi</small>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">2-ombor: Yarim tayyor mahsulot ombori <span class="text-danger">*</span></label>
                            <select class="form-select" name="output_warehouse_id" required title="Tayyor mahsulot shu omborga yoziladi" {% if not wh_list %}disabled{% endif %}>
                                <option value="">Tanlang...</option>
                                {% for wh in wh_list %}
                                <option value="{{ wh.id }}">{{ wh.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Ishlab chiqarilgan mahsulot shu omborga jo'natiladi</small>
                        </div>
                        <div class="col-md-6"></div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Uskuna</label>
                            <select class="form-select" name="machine_id">
                                <option value="">— Tanlash —</option>
                                {% for m in machines or [] %}
                                <option value="{{ m.id }}">{{ m.name }} ({{ m.code }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Operator (xodim)</label>
                            <select class="form-select" name="operator_id">
                                <option value="" {% if not current_user_employee_id %}selected{% endif %}>{{ current_user.full_name if (current_user and not current_user_employee_id) else '— Tanlash —' }}</option>
                                {% for emp in employees or [] %}
                                <option value="{{ emp.id }}" {% if current_user_employee_id and emp.id == current_user_employee_id %}selected{% endif %}>{{ emp.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Ishlab chiqarish miqdori (kg) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control form-control-lg" name="quantity" 
                                   id="quantityInput" value="10" step="0.01" min="0.01" required 
                                   onchange="calculateMaterials()" title="Miqdorni o'zgartirish: F4 — kalkulyator">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Chiqish miqdori</label>
                            <div class="form-control form-control-lg bg-light" id="outputQuantity">
                                - kg
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Izoh</label>
                        <textarea class="form-control" name="note" rows="2" placeholder="Qo'shimcha ma'lumotlar..."></textarea>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-play-fill"></i> Ishlab chiqarishni boshlash
                        </button>
                        <a href="/production" class="btn btn-outline-secondary btn-lg">Bekor qilish</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Retsept ma'lumoti -->
        <div class="card" id="recipeInfoCard" style="display: none;">
            <div class="card-header">
                <i class="bi bi-journal-text"></i> Retsept ma'lumoti
            </div>
            <div class="card-body">
                <div id="recipeInfo">
                    <p class="text-muted">Retsept tanlang</p>
                </div>
            </div>
        </div>
        
        <!-- Kerakli xom ashyolar -->
        <div class="card mt-3" id="materialsCard" style="display: none;">
            <div class="card-header">
                <i class="bi bi-list-check"></i> Kerakli xom ashyolar
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush" id="materialsList">
                </ul>
            </div>
        </div>
        
        <!-- Qisqa yo'riqnoma -->
        <div class="card mt-3 border-info">
            <div class="card-body">
                <h6><i class="bi bi-info-circle text-info"></i> Yo'riqnoma</h6>
                <ol class="small mb-0">
                    <li>Retseptni tanlang</li>
                    <li>Miqdorni kiriting (kg)</li>
                    <li>Omborni tanlang</li>
                    <li>"Boshlash" tugmasini bosing</li>
                    <li>Yakunlagandan keyin "Yakunlash" bosing</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- F4 kalkulyator -->
<div class="modal fade" id="calcModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title"><i class="bi bi-calculator"></i> Kalkulyator (F4)</h6>
                <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <input type="text" class="form-control form-control-lg mb-2 text-end font-monospace" id="calcDisplay" value="0" style="font-size:1.25rem;" placeholder="Klaviaturada yozing yoki tugmalardan foydalaning" autocomplete="off" inputmode="decimal">
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-danger w-100 btn-sm" id="calcBtnC">C</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 btn-sm" id="calcBtnCE">CE</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 btn-sm" id="calcBtnBack">&larr;</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 btn-sm" disabled>/</button></div>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="7">7</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="8">8</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="9">9</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 btn-sm" disabled>*</button></div>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="4">4</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="5">5</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="6">6</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-primary w-100 btn-sm" id="calcBtnMinus">−</button></div>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="1">1</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="2">2</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="3">3</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-primary w-100 btn-sm" id="calcBtnPlus">+</button></div>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="0">0</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100" id="calcBtn00">00</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100" id="calcBtnComma">,</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-primary w-100 btn-sm" id="calcBtnEq">=</button></div>
                </div>
                <div class="row g-1">
                    <div class="col-12"><button type="button" class="btn btn-success w-100" id="calcOK">OK — qiymatni qo‘yish</button></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var calcTargetInput = null;
    var calcAcc = 0;
    var calcDisplayStr = '0';
    var calcNewEntry = false;
    var calcDisplayEl = null;

    function calcParse(s) {
        if (!s) return 0;
        var n = parseFloat(String(s).replace(',', '.')) || 0;
        return isNaN(n) ? 0 : n;
    }
    function calcFormat(n) {
        var r = Math.round(parseFloat(n) * 1e6) / 1e6;
        var s = String(r).replace('.', ',');
        return s;
    }
    function calcNorm(s) {
        s = String(s || '0').replace(',', '.').replace(/[^\d.]/g, '');
        var parts = s.split('.');
        if (parts.length > 2) s = parts[0] + '.' + parts.slice(1).join('');
        if (s === '' || s === '.') s = '0';
        if (s.indexOf('.') === 0) s = '0' + s;
        s = s.replace(/^0+(\d)/, '$1').replace(/^0+$/, '0');
        return s.replace('.', ',');
    }
    function calcUpdateDisplay() {
        if (calcDisplayEl) calcDisplayEl.value = calcDisplayStr;
    }

    function calcInput(ch) {
        if (ch === 'C') {
            calcAcc = 0;
            calcDisplayStr = '0';
            calcNewEntry = false;
            calcUpdateDisplay();
            return;
        }
        if (ch === 'CE') {
            calcDisplayStr = '0';
            calcNewEntry = false;
            calcUpdateDisplay();
            return;
        }
        if (ch === '+') {
            calcAcc = Math.round((calcAcc + calcParse(calcDisplayStr)) * 1e6) / 1e6;
            calcDisplayStr = calcFormat(calcAcc);
            calcNewEntry = true;
            calcUpdateDisplay();
            return;
        }
        if (ch === '-') {
            calcAcc = Math.round((calcAcc - calcParse(calcDisplayStr)) * 1e6) / 1e6;
            calcDisplayStr = calcFormat(calcAcc);
            calcNewEntry = true;
            calcUpdateDisplay();
            return;
        }
        if (ch === '=') {
            calcAcc = Math.round((calcAcc + calcParse(calcDisplayStr)) * 1e6) / 1e6;
            calcDisplayStr = calcFormat(calcAcc);
            calcNewEntry = true;
            calcUpdateDisplay();
            return;
        }
        if (ch === '\u2190' || ch === 'Back') {
            calcDisplayStr = calcDisplayStr.slice(0, -1) || '0';
            calcNewEntry = false;
            calcUpdateDisplay();
            return;
        }
        if (ch === '00') {
            if (calcNewEntry) { calcDisplayStr = '0'; calcNewEntry = false; }
            else if (calcDisplayStr !== '0') calcDisplayStr += '00';
            calcUpdateDisplay();
            return;
        }
        if (ch === '.' || ch === ',') {
            if (calcNewEntry) { calcDisplayStr = '0,'; calcNewEntry = false; }
            else if (calcDisplayStr.indexOf(',') === -1) calcDisplayStr += ',';
            calcUpdateDisplay();
            return;
        }
        if (/^\d$/.test(ch)) {
            if (calcNewEntry) {
                calcDisplayStr = ch === '0' ? '0' : ch;
                calcNewEntry = false;
            } else {
                if (calcDisplayStr === '0' && ch !== '0') calcDisplayStr = ch;
                else calcDisplayStr += ch;
            }
            calcUpdateDisplay();
        }
    }

    function calcBack() { calcInput('Back'); }

    window.openCalcForInput = function(inputEl) {
        if (!inputEl || (inputEl.type !== 'number' && inputEl.type !== 'text')) return;
        calcTargetInput = inputEl;
        var v = (inputEl.value || '0').toString();
        calcDisplayStr = calcNorm(v);
        calcAcc = 0;
        calcNewEntry = false;
        calcDisplayEl = document.getElementById('calcDisplay');
        calcUpdateDisplay();
        var modal = new bootstrap.Modal(document.getElementById('calcModal'));
        modal.show();
    };

    document.addEventListener('DOMContentLoaded', function() {
        calcDisplayEl = document.getElementById('calcDisplay');
        document.getElementById('calcBtnC').onclick = function() { calcInput('C'); };
        document.getElementById('calcBtnCE').onclick = function() { calcInput('CE'); };
        document.getElementById('calcBtnBack').onclick = function() { calcInput('Back'); };
        document.getElementById('calcBtnPlus').onclick = function() { calcInput('+'); };
        document.getElementById('calcBtnMinus').onclick = function() { calcInput('-'); };
        document.getElementById('calcBtnEq').onclick = function() { calcInput('='); };
        document.getElementById('calcBtn00').onclick = function() { calcInput('00'); };
        document.getElementById('calcBtnComma').onclick = function() { calcInput(','); };
        document.querySelectorAll('.calcDigit').forEach(function(btn) {
            btn.onclick = function() { calcInput(btn.getAttribute('data-digit')); };
        });
        calcDisplayEl.addEventListener('input', function() {
            calcDisplayStr = calcNorm(this.value);
            calcNewEntry = false;
            this.value = calcDisplayStr;
        });
        calcDisplayEl.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); document.getElementById('calcOK').click(); return; }
            if (e.key === 'Escape') { e.preventDefault(); bootstrap.Modal.getInstance(document.getElementById('calcModal')).hide(); return; }
            if (e.key >= '0' && e.key <= '9') { e.preventDefault(); calcInput(e.key); return; }
            if (e.key === ',' || e.key === '.') { e.preventDefault(); calcInput(','); return; }
            if (e.key === '+') { e.preventDefault(); calcInput('+'); return; }
            if (e.key === '-') { e.preventDefault(); calcInput('-'); return; }
            if (e.key === '=') { e.preventDefault(); calcInput('='); return; }
            if (e.key === 'Backspace') { e.preventDefault(); calcBack(); }
        });
        document.getElementById('calcModal').addEventListener('shown.bs.modal', function() {
            calcDisplayEl.value = calcDisplayStr;
            calcDisplayEl.select();
            setTimeout(function() {
                calcDisplayEl.focus();
                calcDisplayEl.select();
            }, 50);
        });
        document.getElementById('calcOK').addEventListener('click', function() {
            calcDisplayStr = calcNorm(calcDisplayEl.value);
            var num;
            if (!calcNewEntry && calcDisplayStr !== '' && calcDisplayStr !== '0') {
                calcAcc = Math.round((calcAcc + calcParse(calcDisplayStr)) * 1e6) / 1e6;
                num = calcAcc;
            } else {
                num = calcParse(calcDisplayStr);
            }
            if (calcTargetInput) {
                calcTargetInput.value = num;
                if (calcTargetInput.id === 'quantityInput' && typeof calculateMaterials === 'function') calculateMaterials();
                calcTargetInput.focus();
            }
            bootstrap.Modal.getInstance(document.getElementById('calcModal')).hide();
            calcTargetInput = null;
        });
        document.getElementById('productionForm').addEventListener('keydown', function(e) {
            if (e.key === 'F4' && e.target && e.target.matches('input[type="number"]')) {
                e.preventDefault();
                openCalcForInput(e.target);
            }
        });
    });
})();
</script>

<script>
var recipes = {
    {% for recipe in recipes %}
    {% set _rname = (recipe.name or '')|lower %}
    {% set _kg_per_unit = 0.25 if ('250gr' in _rname or '250 gr' in _rname) else (0.4 if ('400gr' in _rname or '400 gr' in _rname) else (5.0 if ('5kg' in _rname or '5 kg' in _rname) else (4.0 if ('4kg' in _rname or '4 kg' in _rname) else (3.0 if ('3kg' in _rname or '3 kg' in _rname) else (2.0 if ('2kg' in _rname or '2 kg' in _rname) else (1.0 if ('1kg' in _rname or '1 kg' in _rname) else (recipe.output_quantity or 1))))))) %}
    {{ recipe.id }}: {
        name: "{{ recipe.name }}",
        output: {{ _kg_per_unit }},
        items: [
            {% for item in recipe.items %}
            {
                name: "{{ item.product.name if item.product else 'Noma\'lum' }}",
                quantity: {{ item.quantity }},
                product_id: {{ item.product_id }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

// Retsept qidirish funksiyasi
(function() {
    var recipeSearch = document.getElementById('recipeSearch');
    var recipeSelect = document.getElementById('recipeSelect');
    var recipeSelectHidden = document.getElementById('recipeSelectHidden');
    var recipeSearchResults = document.getElementById('recipeSearchResults');
    
    if (!recipeSearch || !recipeSelect || !recipeSelectHidden || !recipeSearchResults) return;
    
    function showRecipeResults(term) {
        term = (term || '').trim().toLowerCase();
        recipeSearchResults.innerHTML = '';
        recipeSearchResults.classList.remove('show');
        recipeSearchResults.style.setProperty('display', 'none', 'important');
        
        if (!term) {
            recipeSelect.value = '';
            updateRecipeInfo();
            return;
        }
        
        const options = Array.from(recipeSelectHidden.options).slice(1);
        const matches = options.filter(function(opt) {
            const name = (opt.dataset.name || opt.textContent || '').toLowerCase();
            return name.indexOf(term) !== -1;
        });
        
        if (matches.length > 0) {
            const inputRect = recipeSearch.getBoundingClientRect();
            recipeSearchResults.style.position = 'fixed';
            recipeSearchResults.style.left = inputRect.left + 'px';
            recipeSearchResults.style.top = (inputRect.bottom + 2) + 'px';
            recipeSearchResults.style.width = inputRect.width + 'px';
            recipeSearchResults.style.maxHeight = '300px';
            recipeSearchResults.style.overflowY = 'auto';
            recipeSearchResults.style.zIndex = '9999';
            recipeSearchResults.classList.add('show');
            recipeSearchResults.style.setProperty('display', 'block', 'important');
            
            matches.forEach(function(opt) {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                const displayName = opt.dataset.name || opt.textContent || '';
                const defaultWh = opt.getAttribute('data-default-warehouse') || '';
                const defaultOutWh = opt.getAttribute('data-default-output-warehouse') || '';
                item.innerHTML = '<strong>' + displayName + '</strong>';
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    recipeSearch.value = displayName;
                    recipeSelect.value = opt.value;
                    recipeSearchResults.classList.remove('show');
                    recipeSearchResults.style.setProperty('display', 'none', 'important');
                    if (defaultWh) {
                        var s = document.querySelector('select[name="warehouse_id"]');
                        if (s) s.value = defaultWh;
                    }
                    if (defaultOutWh) {
                        var s = document.querySelector('select[name="output_warehouse_id"]');
                        if (s) s.value = defaultOutWh;
                    }
                    updateRecipeInfo();
                });
                recipeSearchResults.appendChild(item);
            });
        } else {
            const inputRect = recipeSearch.getBoundingClientRect();
            recipeSearchResults.style.position = 'fixed';
            recipeSearchResults.style.left = inputRect.left + 'px';
            recipeSearchResults.style.top = (inputRect.bottom + 2) + 'px';
            recipeSearchResults.style.width = inputRect.width + 'px';
            recipeSearchResults.style.zIndex = '9999';
            recipeSearchResults.classList.add('show');
            recipeSearchResults.style.setProperty('display', 'block', 'important');
            recipeSearchResults.innerHTML = '<div class="list-group-item text-muted">Topilmadi.</div>';
        }
    }
    
    recipeSearch.addEventListener('focus', function() {
        const currentValue = this.value.trim();
        if (currentValue) {
            showRecipeResults(currentValue);
        }
    });
    
    recipeSearch.addEventListener('input', function() {
        showRecipeResults(this.value);
    });
    
    recipeSearch.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            recipeSearchResults.classList.remove('show');
            recipeSearchResults.style.setProperty('display', 'none', 'important');
        }
    });
    
    document.addEventListener('click', function(e) {
        if (!recipeSearch.contains(e.target) && !recipeSearchResults.contains(e.target)) {
            recipeSearchResults.classList.remove('show');
            recipeSearchResults.style.setProperty('display', 'none', 'important');
        }
    });
    
    // Retsept tanlanganda avtomatik yangilash
    recipeSelect.addEventListener('input', function() {
        updateRecipeInfo();
    });
})();

function updateRecipeInfo() {
    var select = document.getElementById('recipeSelect');
    var recipeId = select.value;
    
    if (recipeId && recipes[recipeId]) {
        var recipe = recipes[recipeId];
        
        document.getElementById('recipeInfoCard').style.display = 'block';
        document.getElementById('materialsCard').style.display = 'block';
        
        document.getElementById('recipeInfo').innerHTML = 
            '<strong>' + recipe.name + '</strong><br>' +
            '<span class="text-muted">' + recipe.items.length + ' xom ashyo</span><br>' +
            '<span class="text-muted">Chiqish: ' + recipe.output + ' kg</span>';
        
        calculateMaterials();
    } else {
        document.getElementById('recipeInfoCard').style.display = 'none';
        document.getElementById('materialsCard').style.display = 'none';
    }
}

function calculateMaterials() {
    var recipeId = document.getElementById('recipeSelect').value;
    var quantity = parseFloat(document.getElementById('quantityInput').value) || 0;
    
    if (recipeId && recipes[recipeId]) {
        var recipe = recipes[recipeId];
        
        // Chiqish miqdori — yaxlitlanmasin, kiritilgan miqdor bo'yicha (2 xona kasr)
        var outputVal = quantity * recipe.output;
        document.getElementById('outputQuantity').textContent = 
            (Math.round(outputVal * 100) / 100).toFixed(2) + ' kg';
        
        // Xom ashyolar (editable)
        var html = '';
        recipe.items.forEach(function(item, idx) {
            var needed = (item.quantity * quantity).toFixed(2);
            html += `<li class="list-group-item d-flex align-items-center gap-2">
                <input type="hidden" name="material_product_id[]" value="${item.product_id || ''}">
                <span class="flex-grow-1">${item.name}</span>
                <input type="number" step="0.01" min="0" name="material_quantity[]" value="${needed}" class="form-control form-control-sm" style="width:90px; text-align:right;">
                <span class="ms-1">kg</span>
            </li>`;
        });
        document.getElementById('materialsList').innerHTML = html || 
            '<li class="list-group-item text-muted">Tarkib bo\'sh</li>';
    }
}
</script>
{% endblock %}
