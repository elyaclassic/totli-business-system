{% extends "base.html" %}

{% block content %}
<style>
    .recipe_search_results {
        position: fixed !important;
        z-index: 9999 !important;
        max-height: 300px !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        display: none !important;
        background: white !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 0.25rem !important;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15) !important;
    }
    .recipe_search_results.show {
        display: block !important;
    }
    .recipe_search_results .list-group-item:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }
</style>
<div class="d-flex justify-content-between mb-4">
    <h4><i class="bi bi-gear-fill"></i> Ishlab chiqarish</h4>
    <a href="/production/new" class="btn btn-primary">
        <i class="bi bi-plus"></i> Yangi ishlab chiqarish
    </a>
</div>

<!-- Statistika -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between">
                <div>
                    <p>Retseptlar</p>
                    <h3>{{ total_recipes }}</h3>
                </div>
                <div class="icon blue">
                    <i class="bi bi-journal-text"></i>
                </div>
            </div>
            <a href="/production/recipes" class="text-primary small">Barchasi →</a>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between">
                <div>
                    <p>Bugun ishlab chiqarildi</p>
                    <h3>{{ "%.1f"|format(today_quantity or 0) }} kg</h3>
                    <div class="small mt-1 text-muted">
                        <span class="d-block">Yarim tayyor: {{ "%.1f"|format(today_quantity_yarim or 0) }} kg</span>
                        <span class="d-block">Tayyor: {{ "%.1f"|format(today_quantity_tayyor or 0) }} kg</span>
                    </div>
                </div>
                <div class="icon green">
                    <i class="bi bi-box-seam"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between">
                <div>
                    <p>Kutilmoqda</p>
                    <h3>{{ pending_productions }}</h3>
                </div>
                <div class="icon orange">
                    <i class="bi bi-hourglass-split"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between">
                <div>
                    <p>Buyurtmalar</p>
                    <h3>{{ recent_productions|length }}</h3>
                </div>
                <div class="icon purple">
                    <i class="bi bi-clipboard-check"></i>
                </div>
            </div>
            <a href="/production/orders" class="text-primary small">Barchasi (bosqichlar) →</a>
            <a href="/production/by-operator" class="text-primary small d-block mt-1">Operator bo'yicha →</a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Tezkor ishlab chiqarish -->
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightning-fill text-warning"></i> Tezkor ishlab chiqarish
            </div>
            <div class="card-body">
                <form method="POST" action="/production/create">
                    <div class="mb-3">
                        <label class="form-label">Retsept</label>
                        <div class="recipe-search-wrapper" style="position: relative;">
                            <input type="text" class="form-control recipe-search-input" id="quickRecipeSearch" 
                                placeholder="Retsept nomini yozib qidiring..." autocomplete="off">
                            <input type="hidden" name="recipe_id" id="quickRecipeSelect" required>
                            <div class="recipe_search_results list-group" id="quickRecipeSearchResults" style="display: none;"></div>
                        </div>
                        <select id="quickRecipeSelectHidden" style="display: none;">
                            <option value="">Tanlang...</option>
                            {% for recipe in recipes %}
                            <option value="{{ recipe.id }}" data-name="{{ recipe.name|e }}" data-unit="{{ recipe.product.unit.name if recipe.product and recipe.product.unit else 'kg' }}" data-default-warehouse="{{ recipe.default_warehouse_id or '' }}" data-default-output-warehouse="{{ recipe.default_output_warehouse_id or '' }}">{{ recipe.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">1-ombor: Xom ashyo ombori</label>
                        {% set wh_list = warehouses or [] %}
                        {% if not wh_list %}
                        <div class="alert alert-warning py-2 mb-0">
                            <small><i class="bi bi-exclamation-triangle"></i> Omborlar ro'yxati bo'sh. Avval <a href="/info/warehouses">Ma'lumotnomalar → Omborlar</a> orqali ombor qo'shing.</small>
                        </div>
                        {% endif %}
                        <select class="form-select" name="warehouse_id" required {% if not wh_list %}disabled{% endif %}>
                            <option value="">Tanlang...</option>
                            {% for wh in wh_list %}
                            <option value="{{ wh.id }}">{{ wh.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">2-ombor: Yarim tayyor ombori</label>
                        <select class="form-select" name="output_warehouse_id" required {% if not wh_list %}disabled{% endif %}>
                            <option value="">Tanlang...</option>
                            {% for wh in wh_list %}
                            <option value="{{ wh.id }}">{{ wh.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Miqdori (<span id="quickQuantityUnit">kg</span>)</label>
                        <input type="number" class="form-control" name="quantity" id="quickQuantityInput" step="0.01" min="0.01" value="10" required title="F4 — kalkulyator">
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-play-fill"></i> Boshlash
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Retseptlar -->
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between">
                <span><i class="bi bi-journal-text"></i> Retseptlar</span>
                <a href="/production/recipes" class="btn btn-sm btn-outline-primary">Barchasi</a>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for recipe in recipes[:5] %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ recipe.name }}</span>
                        <span class="badge bg-primary">{{ recipe.items|length }} xom ashyo</span>
                    </li>
                    {% else %}
                    <li class="list-group-item text-center text-muted">Retseptlar yo'q</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Oxirgi ishlab chiqarishlar -->
    <div class="col-md-7">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <span><i class="bi bi-clock-history"></i> Oxirgi ishlab chiqarishlar</span>
                <a href="/production/orders" class="btn btn-sm btn-outline-primary" title="Buyurtmalar ro'yxati va bosqichlar">Buyurtmalar (bosqichlar)</a>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Raqam</th>
                            <th>Retsept</th>
                            <th>Miqdor</th>
                            <th>Sana</th>
                            <th>Holat</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for prod in recent_productions %}
                        <tr>
                            <td><strong>{{ prod.number }}</strong></td>
                            <td>
                                {% if prod.recipe %}
                                <a href="/production/recipes/{{ prod.recipe_id }}">{{ prod.recipe.name }}</a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% set _unit = (prod.recipe.product.unit.name if prod.recipe and prod.recipe.product and prod.recipe.product.unit else 'kg') %}
                                {% set _rname = (prod.recipe.name or '')|lower if prod.recipe else '' %}
                                {% set _kg_per_unit = 0.25 if ('250gr' in _rname or '250 gr' in _rname) else (0.4 if ('400gr' in _rname or '400 gr' in _rname) else (5.0 if ('5kg' in _rname or '5 kg' in _rname) else (4.0 if ('4kg' in _rname or '4 kg' in _rname) else (3.0 if ('3kg' in _rname or '3 kg' in _rname) else (2.0 if ('2kg' in _rname or '2 kg' in _rname) else (1.0 if ('1kg' in _rname or '1 kg' in _rname) else (prod.recipe.output_quantity if prod.recipe and prod.recipe.output_quantity else 1))))))) %}
                                {{ "%.2f"|format(prod.quantity or 0) }} {{ _unit }}{% if _unit|lower != 'kg' %} <span class="text-muted small">({{ "%.2f"|format((prod.quantity or 0) * _kg_per_unit) }} kg)</span>{% endif %}
                            </td>
                            <td>{{ prod.date.strftime('%d.%m.%Y %H:%M') if prod.date else '-' }}</td>
                            <td>
                                {% if prod.status == 'completed' %}
                                <span class="badge bg-success">Yakunlandi</span>
                                {% elif prod.status == 'draft' %}
                                <span class="badge bg-warning">Kutilmoqda</span>
                                {% else %}
                                <span class="badge bg-danger">Bekor</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                <i class="bi bi-inbox fs-1"></i><br>
                                Ishlab chiqarish yo'q
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- F4 kalkulyator (tezkor ishlab chiqarish) -->
<div class="modal fade" id="calcModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title"><i class="bi bi-calculator"></i> Kalkulyator (F4)</h6>
                <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <input type="text" class="form-control form-control-lg mb-2 text-end font-monospace" id="calcDisplay" value="0" style="font-size:1.25rem;" placeholder="Klaviaturada yozing yoki tugmalardan foydalaning" autocomplete="off" inputmode="decimal">
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-danger w-100 btn-sm" id="calcBtnC">C</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 btn-sm" id="calcBtnCE">CE</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 btn-sm" id="calcBtnBack">&larr;</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 btn-sm" disabled>/</button></div>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="7">7</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="8">8</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="9">9</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-secondary w-100 btn-sm" disabled>*</button></div>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="4">4</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="5">5</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="6">6</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-primary w-100 btn-sm" id="calcBtnMinus">−</button></div>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="1">1</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="2">2</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="3">3</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-primary w-100 btn-sm" id="calcBtnPlus">+</button></div>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100 calcDigit" data-digit="0">0</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100" id="calcBtn00">00</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-dark w-100" id="calcBtnComma">,</button></div>
                    <div class="col-3"><button type="button" class="btn btn-outline-primary w-100 btn-sm" id="calcBtnEq">=</button></div>
                </div>
                <div class="row g-1">
                    <div class="col-12"><button type="button" class="btn btn-success w-100" id="calcOK">OK — qiymatni qo'yish</button></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var calcTargetInput = null;
    var calcAcc = 0;
    var calcDisplayStr = '0';
    var calcNewEntry = false;
    var calcDisplayEl = null;
    function calcParse(s) {
        if (!s) return 0;
        var n = parseFloat(String(s).replace(',', '.')) || 0;
        return isNaN(n) ? 0 : n;
    }
    function calcFormat(n) {
        var r = Math.round(parseFloat(n) * 1e6) / 1e6;
        return String(r).replace('.', ',');
    }
    function calcNorm(s) {
        s = String(s || '0').replace(',', '.').replace(/[^\d.]/g, '');
        var parts = s.split('.');
        if (parts.length > 2) s = parts[0] + '.' + parts.slice(1).join('');
        if (s === '' || s === '.') s = '0';
        if (s.indexOf('.') === 0) s = '0' + s;
        s = s.replace(/^0+(\d)/, '$1').replace(/^0+$/, '0');
        return s.replace('.', ',');
    }
    function calcUpdateDisplay() { if (calcDisplayEl) calcDisplayEl.value = calcDisplayStr; }
    function calcInput(ch) {
        if (ch === 'C') { calcAcc = 0; calcDisplayStr = '0'; calcNewEntry = false; calcUpdateDisplay(); return; }
        if (ch === 'CE') { calcDisplayStr = '0'; calcNewEntry = false; calcUpdateDisplay(); return; }
        if (ch === '+') { calcAcc = Math.round((calcAcc + calcParse(calcDisplayStr)) * 1e6) / 1e6; calcDisplayStr = calcFormat(calcAcc); calcNewEntry = true; calcUpdateDisplay(); return; }
        if (ch === '-') { calcAcc = Math.round((calcAcc - calcParse(calcDisplayStr)) * 1e6) / 1e6; calcDisplayStr = calcFormat(calcAcc); calcNewEntry = true; calcUpdateDisplay(); return; }
        if (ch === '=') { calcAcc = Math.round((calcAcc + calcParse(calcDisplayStr)) * 1e6) / 1e6; calcDisplayStr = calcFormat(calcAcc); calcNewEntry = true; calcUpdateDisplay(); return; }
        if (ch === '\u2190' || ch === 'Back') { calcDisplayStr = calcDisplayStr.slice(0, -1) || '0'; calcNewEntry = false; calcUpdateDisplay(); return; }
        if (ch === '00') {
            if (calcNewEntry) { calcDisplayStr = '0'; calcNewEntry = false; } else if (calcDisplayStr !== '0') calcDisplayStr += '00';
            calcUpdateDisplay(); return;
        }
        if (ch === '.' || ch === ',') {
            if (calcNewEntry) { calcDisplayStr = '0,'; calcNewEntry = false; } else if (calcDisplayStr.indexOf(',') === -1) calcDisplayStr += ',';
            calcUpdateDisplay(); return;
        }
        if (/^\d$/.test(ch)) {
            if (calcNewEntry) { calcDisplayStr = ch === '0' ? '0' : ch; calcNewEntry = false; }
            else { if (calcDisplayStr === '0' && ch !== '0') calcDisplayStr = ch; else calcDisplayStr += ch; }
            calcUpdateDisplay();
        }
    }
    window.openCalcForInput = function(inputEl) {
        if (!inputEl || (inputEl.type !== 'number' && inputEl.type !== 'text')) return;
        calcTargetInput = inputEl;
        calcDisplayStr = calcNorm((inputEl.value || '0').toString());
        calcAcc = 0;
        calcNewEntry = false;
        calcDisplayEl = document.getElementById('calcDisplay');
        calcUpdateDisplay();
        var modal = new bootstrap.Modal(document.getElementById('calcModal'));
        modal.show();
    };
    document.addEventListener('DOMContentLoaded', function() {
        calcDisplayEl = document.getElementById('calcDisplay');
        document.getElementById('calcBtnC').onclick = function() { calcInput('C'); };
        document.getElementById('calcBtnCE').onclick = function() { calcInput('CE'); };
        document.getElementById('calcBtnBack').onclick = function() { calcInput('Back'); };
        document.getElementById('calcBtnPlus').onclick = function() { calcInput('+'); };
        document.getElementById('calcBtnMinus').onclick = function() { calcInput('-'); };
        document.getElementById('calcBtnEq').onclick = function() { calcInput('='); };
        document.getElementById('calcBtn00').onclick = function() { calcInput('00'); };
        document.getElementById('calcBtnComma').onclick = function() { calcInput(','); };
        document.querySelectorAll('.calcDigit').forEach(function(btn) { btn.onclick = function() { calcInput(btn.getAttribute('data-digit')); }; });
        calcDisplayEl.addEventListener('input', function() {
            calcDisplayStr = calcNorm(this.value);
            calcNewEntry = false;
            this.value = calcDisplayStr;
        });
        calcDisplayEl.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); document.getElementById('calcOK').click(); return; }
            if (e.key === 'Escape') { e.preventDefault(); bootstrap.Modal.getInstance(document.getElementById('calcModal')).hide(); return; }
            if (e.key >= '0' && e.key <= '9') { e.preventDefault(); calcInput(e.key); return; }
            if (e.key === ',' || e.key === '.') { e.preventDefault(); calcInput(','); return; }
            if (e.key === '+') { e.preventDefault(); calcInput('+'); return; }
            if (e.key === '-') { e.preventDefault(); calcInput('-'); return; }
            if (e.key === '=') { e.preventDefault(); calcInput('='); return; }
            if (e.key === 'Backspace') { e.preventDefault(); calcInput('Back'); }
        });
        document.getElementById('calcModal').addEventListener('shown.bs.modal', function() {
            calcDisplayEl.value = calcDisplayStr;
            calcDisplayEl.select();
            setTimeout(function() { calcDisplayEl.focus(); calcDisplayEl.select(); }, 50);
        });
        document.getElementById('calcOK').addEventListener('click', function() {
            calcDisplayStr = calcNorm(calcDisplayEl.value);
            var num;
            if (!calcNewEntry && calcDisplayStr !== '' && calcDisplayStr !== '0') {
                calcAcc = Math.round((calcAcc + calcParse(calcDisplayStr)) * 1e6) / 1e6;
                num = calcAcc;
            } else {
                num = calcParse(calcDisplayStr);
            }
            if (calcTargetInput) { calcTargetInput.value = num; calcTargetInput.focus(); }
            bootstrap.Modal.getInstance(document.getElementById('calcModal')).hide();
            calcTargetInput = null;
        });
        var qtyInput = document.getElementById('quickQuantityInput');
        if (qtyInput) qtyInput.addEventListener('keydown', function(e) {
            if (e.key === 'F4') { e.preventDefault(); openCalcForInput(this); }
        });
        // Retsept qidirish funksiyasi
        var quickRecipeSearch = document.getElementById('quickRecipeSearch');
        var quickRecipeSelect = document.getElementById('quickRecipeSelect');
        var quickRecipeSelectHidden = document.getElementById('quickRecipeSelectHidden');
        var quickRecipeSearchResults = document.getElementById('quickRecipeSearchResults');
        var quickQuantityUnit = document.getElementById('quickQuantityUnit');
        
        function showRecipeResults(term) {
            term = (term || '').trim().toLowerCase();
            quickRecipeSearchResults.innerHTML = '';
            quickRecipeSearchResults.classList.remove('show');
            quickRecipeSearchResults.style.setProperty('display', 'none', 'important');
            
            if (!term) {
                quickRecipeSelect.value = '';
                if (quickQuantityUnit) quickQuantityUnit.textContent = 'kg';
                return;
            }
            
            if (!quickRecipeSelectHidden) return;
            
            const options = Array.from(quickRecipeSelectHidden.options).slice(1);
            const matches = options.filter(function(opt) {
                const name = (opt.dataset.name || opt.textContent || '').toLowerCase();
                return name.indexOf(term) !== -1;
            });
            
            if (matches.length > 0) {
                const inputRect = quickRecipeSearch.getBoundingClientRect();
                quickRecipeSearchResults.style.position = 'fixed';
                quickRecipeSearchResults.style.left = inputRect.left + 'px';
                quickRecipeSearchResults.style.top = (inputRect.bottom + 2) + 'px';
                quickRecipeSearchResults.style.width = inputRect.width + 'px';
                quickRecipeSearchResults.style.maxHeight = '300px';
                quickRecipeSearchResults.style.overflowY = 'auto';
                quickRecipeSearchResults.style.zIndex = '9999';
                quickRecipeSearchResults.classList.add('show');
                quickRecipeSearchResults.style.setProperty('display', 'block', 'important');
                
                matches.forEach(function(opt) {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    const displayName = opt.dataset.name || opt.textContent || '';
                    item.innerHTML = '<strong>' + displayName + '</strong>';
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        quickRecipeSearch.value = displayName;
                        quickRecipeSelect.value = opt.value;
                        quickRecipeSearchResults.classList.remove('show');
                        quickRecipeSearchResults.style.setProperty('display', 'none', 'important');
                        
                        // Unit ni yangilash
                        if (quickQuantityUnit) {
                            const unit = opt.getAttribute('data-unit') || 'kg';
                            quickQuantityUnit.textContent = unit;
                        }
                        // Retseptga biriktirilgan omborlarni to'ldirish
                        var dw = opt.getAttribute('data-default-warehouse');
                        var dow = opt.getAttribute('data-default-output-warehouse');
                        if (dw) {
                            var sel = document.querySelector('form[action="/production/create"] select[name="warehouse_id"]');
                            if (sel) sel.value = dw;
                        }
                        if (dow) {
                            var sel = document.querySelector('form[action="/production/create"] select[name="output_warehouse_id"]');
                            if (sel) sel.value = dow;
                        }
                    });
                    quickRecipeSearchResults.appendChild(item);
                });
            } else {
                const inputRect = quickRecipeSearch.getBoundingClientRect();
                quickRecipeSearchResults.style.position = 'fixed';
                quickRecipeSearchResults.style.left = inputRect.left + 'px';
                quickRecipeSearchResults.style.top = (inputRect.bottom + 2) + 'px';
                quickRecipeSearchResults.style.width = inputRect.width + 'px';
                quickRecipeSearchResults.style.zIndex = '9999';
                quickRecipeSearchResults.classList.add('show');
                quickRecipeSearchResults.style.setProperty('display', 'block', 'important');
                quickRecipeSearchResults.innerHTML = '<div class="list-group-item text-muted">Topilmadi.</div>';
            }
        }
        
        if (quickRecipeSearch && quickRecipeSelectHidden) {
            quickRecipeSearch.addEventListener('focus', function() {
                const currentValue = this.value.trim();
                if (currentValue) {
                    showRecipeResults(currentValue);
                }
            });
            
            quickRecipeSearch.addEventListener('input', function() {
                showRecipeResults(this.value);
            });
            
            quickRecipeSearch.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    quickRecipeSearchResults.classList.remove('show');
                    quickRecipeSearchResults.style.setProperty('display', 'none', 'important');
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!quickRecipeSearch.contains(e.target) && !quickRecipeSearchResults.contains(e.target)) {
                    quickRecipeSearchResults.classList.remove('show');
                    quickRecipeSearchResults.style.setProperty('display', 'none', 'important');
                }
            });
        }
        
        // Retsept tanlanganda unit ni yangilash
        if (quickRecipeSelect && quickQuantityUnit && quickRecipeSelectHidden) {
            // Hidden input o'zgarganda unit ni yangilash
            var observer = new MutationObserver(function(mutations) {
                if (quickRecipeSelect.value) {
                    var opt = Array.from(quickRecipeSelectHidden.options).find(function(o) {
                        return o.value === quickRecipeSelect.value;
                    });
                    if (opt && opt.getAttribute('data-unit')) {
                        quickQuantityUnit.textContent = opt.getAttribute('data-unit');
                    } else {
                        quickQuantityUnit.textContent = 'kg';
                    }
                }
            });
            
            // Input event listener qo'shish
            if (quickRecipeSelect.addEventListener) {
                quickRecipeSelect.addEventListener('input', function() {
                    if (this.value && quickRecipeSelectHidden) {
                        var opt = Array.from(quickRecipeSelectHidden.options).find(function(o) {
                            return o.value === this.value;
                        });
                        if (opt && opt.getAttribute('data-unit')) {
                            quickQuantityUnit.textContent = opt.getAttribute('data-unit');
                        } else {
                            quickQuantityUnit.textContent = 'kg';
                        }
                    }
                });
            }
        }
    });
})();
</script>
{% endblock %}
