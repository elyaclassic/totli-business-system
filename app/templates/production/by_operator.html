{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <a href="/production" class="btn btn-outline-secondary btn-sm mb-2"><i class="bi bi-arrow-left"></i> Orqaga</a>
            <h4 class="mb-0"><i class="bi bi-person-badge"></i> Operator bo'yicha ishlab chiqarish</h4>
        </div>
    </div>

    <div class="card mb-2">
        <div class="card-body py-2">
            <form method="get" action="/production/by-operator" class="d-flex flex-wrap align-items-center gap-2">
                <label class="form-label mb-0 small text-muted">Sana:</label>
                <input type="date" name="date_from" class="form-control form-control-sm" style="width: auto;" value="{{ filter_date_from or '' }}">
                <span class="small text-muted">—</span>
                <input type="date" name="date_to" class="form-control form-control-sm" style="width: auto;" value="{{ filter_date_to or '' }}">
                <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-filter"></i> Ko'rsatish</button>
            </form>
        </div>
    </div>

    {% if operator_totals %}
    <div class="card mb-2">
        <div class="card-header py-2">
            <i class="bi bi-calculator"></i> Operator bo'yicha jamlanma (qiyom hisobga olinmaydi — yarim tayyor, tayyor, dona)
        </div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Operator</th>
                        <th class="text-end">Jami (kg)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for op_name, total_kg in operator_totals %}
                    <tr>
                        <td>
                            {% set emp_id = name_to_employee_id.get(op_name) %}
                            {% if emp_id %}
                            <a href="/production/orders?operator_id={{ emp_id }}&date_from={{ filter_date_from or '' }}&date_to={{ filter_date_to or '' }}" class="text-primary text-decoration-none"><strong>{{ op_name }}</strong></a>
                            {% else %}
                            <strong>{{ op_name }}</strong>
                            {% endif %}
                        </td>
                        <td class="text-end"><strong>{{ "%.2f"|format(total_kg) }}</strong> kg</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Sana</th>
                        <th>Operator</th>
                        <th>Ishlab chiqargan mahsulot</th>
                        <th>Miqdor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prod in productions %}
                    <tr>
                        <td>{{ prod.date.strftime('%d.%m.%Y %H:%M') if prod.date else '-' }}</td>
                        <td>
                            {% if prod.operator %}
                            <a href="/production/orders?operator_id={{ prod.operator.id }}&date_from={{ filter_date_from or '' }}&date_to={{ filter_date_to or '' }}" class="text-primary text-decoration-none"><strong>{{ prod.operator.full_name }}</strong></a>
                            {% elif prod.user %}
                            <span class="text-muted">{{ prod.user.full_name }}</span>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if prod.recipe %}
                            <a href="/production/{{ prod.id }}/materials">{{ prod.recipe.name }}</a>
                            {% else %}
                            —
                            {% endif %}
                        </td>
                        <td>
                            {% if prod.recipe %}
                            {% set unit_name = (prod.recipe.product.unit.name if prod.recipe.product and prod.recipe.product.unit else 'kg') %}
                            {% set _rname = (prod.recipe.name or '')|lower %}
                            {% set _kg_per_unit = 0.25 if ('250gr' in _rname or '250 gr' in _rname) else (0.4 if ('400gr' in _rname or '400 gr' in _rname) else (5.0 if ('5kg' in _rname or '5 kg' in _rname) else (4.0 if ('4kg' in _rname or '4 kg' in _rname) else (3.0 if ('3kg' in _rname or '3 kg' in _rname) else (2.0 if ('2kg' in _rname or '2 kg' in _rname) else (1.0 if ('1kg' in _rname or '1 kg' in _rname) else (prod.recipe.output_quantity if prod.recipe.output_quantity else 1))))))) %}
                            {% set qty_kg = (prod.quantity or 0) * _kg_per_unit %}
                            <strong>{{ "%.2f"|format(prod.quantity or 0) }} {{ unit_name }}</strong>
                            {% if unit_name|lower != 'kg' %}
                            <span class="text-muted small">({{ "%.2f"|format(qty_kg) }} kg)</span>
                            {% endif %}
                            {% else %}
                            {{ "%.2f"|format(prod.quantity or 0) }} kg
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-4"></i><br>
                            Tanlangan sanada yakunlangan ishlab chiqarish yo'q
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
