{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    {% if request.query_params.get('error') %}
    <div class="alert alert-danger py-2 small">{{ request.query_params.get('error') }}</div>
    {% endif %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="bi bi-file-earmark-person"></i> Ishga qabul qilish hujjati yaratish</h5>
        <a href="/employees/hiring-docs" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Ro'yxatga</a>
    </div>
    <div class="card">
        <div class="card-body">
            <form method="POST" action="/employees/hiring-doc/create">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label">Xodim *</label>
                        <select class="form-select" name="employee_id" required id="empSelect">
                            <option value="">— Xodimni tanlang —</option>
                            {% for e in employees %}
                            <option value="{{ e.id }}" {% if emp and emp.id == e.id %}selected{% endif %}>
                                {{ e.full_name }} ({{ e.code }}){% if e.position %} — {{ e.position }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Hujjat sanasi *</label>
                        <input type="date" class="form-control" name="doc_date" value="{{ request.query_params.get('doc_date', today_str) }}" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Ishga kirgan sana</label>
                        <input type="date" class="form-control" name="hire_date" value="{{ emp.hire_date.strftime('%Y-%m-%d') if emp and emp.hire_date else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Lavozim</label>
                        <select class="form-select" name="position" id="positionSelect">
                            <option value="">— Lavozimni tanlang —</option>
                            {% for p in positions %}
                            <option value="{{ p.name }}" {% if emp and emp.position == p.name %}selected{% endif %}>{{ p.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Ro'yxatda yo'q bo'lsa: <a href="/info/positions" target="_blank">Ma'lumotnomalar → Lavozim</a> da qo'shing</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Bo'lim</label>
                        <select class="form-select" name="department" id="departmentSelect">
                            <option value="">— Bo'limni tanlang —</option>
                            {% for d in departments %}
                            <option value="{{ d.name }}" {% if emp and emp.department == d.name %}selected{% endif %}>{{ d.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Ro'yxatda yo'q bo'lsa: <a href="/info/departments" target="_blank">Ma'lumotnomalar → Bo'limlar</a> da qo'shing</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Oylik turi</label>
                        <select class="form-select" name="salary_type" id="salaryTypeSelect">
                            <option value="">— Tanlang —</option>
                            <option value="oylik" {% if emp and emp.salary_type == 'oylik' %}selected{% endif %}>Oylik</option>
                            <option value="soatlik" {% if emp and emp.salary_type == 'soatlik' %}selected{% endif %}>Soatlik</option>
                            <option value="bo'lak" {% if emp and emp.salary_type == "bo'lak" %}selected{% endif %}>Bo'lak</option>
                        </select>
                        <small class="text-muted">Ro'yxatda yo'q bo'lsa: <a href="/info/piecework-tasks" target="_blank">Ma'lumotnomalar → Bajariladigan ishlar</a></small>
                    </div>
                    <div class="col-md-4" id="pieceworkTaskBlock" style="display: none;">
                        <label class="form-label">Bajariladigan ish (bo'lak narxi)</label>
                        <select class="form-select" name="piecework_task_id" id="pieceworkTaskSelect">
                            <option value="">— Tanlang —</option>
                            {% for t in piecework_tasks or [] %}
                            <option value="{{ t.id }}" {% if emp and emp.piecework_task_id == t.id %}selected{% endif %}>{{ t.name or t.code }} ({{ "{:,.0f}".format(t.price_per_unit or 0) }} so'm)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Oylik (so'm)</label>
                        <input type="number" class="form-control" name="salary" value="{{ emp.salary if emp else 0 }}" step="100000">
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Izoh</label>
                        <input type="text" class="form-control" name="note" placeholder="Ixtiyoriy">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-success"><i class="bi bi-check-lg"></i> Hujjat yaratish</button>
                        <a href="/employees/hiring-docs" class="btn btn-secondary">Bekor</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
(function(){
    var today = new Date().toISOString().slice(0, 10);
    var docDate = document.querySelector('input[name="doc_date"]');
    if (docDate && !docDate.value) docDate.value = today;

    var salaryTypeSelect = document.getElementById('salaryTypeSelect');
    var pieceworkTaskBlock = document.getElementById('pieceworkTaskBlock');
    function togglePiecework() {
        var v = salaryTypeSelect ? salaryTypeSelect.value : '';
        pieceworkTaskBlock.style.display = (v === "bo'lak" || v === 'bo\'lak') ? 'block' : 'none';
    }
    if (salaryTypeSelect) {
        salaryTypeSelect.addEventListener('change', togglePiecework);
        togglePiecework();
    }
})();
</script>
{% endblock %}
