{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="bi bi-file-earmark-plus"></i> Tabel formasi</h5>
        <a href="/employees/attendance" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Ro'yxatga</a>
    </div>

    {% if request.query_params.get('error') %}
    <div class="alert alert-danger alert-dismissible fade show py-2 small">
        {{ request.query_params.get('error') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    {% if request.query_params.get('synced') == '1' %}
    <div class="alert alert-info alert-dismissible fade show py-2 small">
        <i class="bi bi-cloud-download"></i> {{ request.query_params.get('msg', 'Hikvision\'dan yuklandi') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <div class="card mb-3">
        <div class="card-body">
            <form method="get" action="/employees/attendance/form" class="d-flex align-items-end gap-3 flex-wrap" id="attendanceDateForm">
                <div>
                    <label class="form-label small mb-1">Sana</label>
                    <input type="date" name="date" id="attendanceFormDate" class="form-control" value="{{ form_date_str }}" onchange="this.form.submit()" style="width: auto;">
                </div>
                <button type="submit" class="btn btn-sm btn-outline-primary">Ko'rsatish</button>
            </form>
        </div>
    </div>

    {% if doc %}
    <div class="alert alert-success py-2">
        <i class="bi bi-check-circle"></i> Bu kun tasdiqlangan.
        <a href="/employees/attendance/doc/{{ doc.id }}" class="alert-link">{{ doc.number }}</a> —
        <a href="/employees/attendance/doc/{{ doc.id }}">Hujjatni ko'rish</a>
    </div>
    {% else %}
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="d-flex flex-wrap align-items-center gap-3">
                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#hikvisionModal">
                    <i class="bi bi-cloud-download"></i> Hikvision'dan yuklash
                </button>
                <span class="text-muted small">Tanlangan sana: {{ form_date.strftime('%d.%m.%Y') }} bo'yicha yuklanadi.</span>
                <div class="d-flex align-items-center gap-2 ms-auto" id="autoSyncBlock">
                    <label class="form-check-label small mb-0">
                        <input type="checkbox" class="form-check-input" id="autoSyncCheck" title="Hikvision bilan doimiy aloqa — har N daqiqada avtomatik yuklash">
                        Doimiy aloqa (avtomatik yuklash)
                    </label>
                    <select class="form-select form-select-sm" id="autoSyncInterval" style="width: auto;">
                        <option value="5">Har 5 daqiqa</option>
                        <option value="10">Har 10 daqiqa</option>
                        <option value="15">Har 15 daqiqa</option>
                    </select>
                    <span class="text-muted small" id="autoSyncStatus"></span>
                </div>
            </div>
            <p class="small text-muted mb-0 mt-2" id="autoSyncHint">Avval bir marta «Hikvision'dan yuklash» tugmasini bosing va kirish ma'lumotlarini kiriting — keyin doimiy aloqa ishlaydi.</p>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Barcha xodimlar ({{ attendance_rows|length }} ta) — keldi: {{ attendances|length }} ta</span>
            {% if current_user and current_user.role == 'admin' %}
            <form method="POST" action="/employees/attendance/form/confirm" class="d-inline">
                <input type="hidden" name="date" value="{{ form_date_str }}">
                <button type="submit" class="btn btn-sm btn-success" {% if not attendances %}disabled{% endif %} onclick="return confirm('{{ form_date.strftime('%d.%m.%Y') }} kunini tasdiqlashni xohlaysizmi? Hujjat yaratiladi.');">
                    <i class="bi bi-check-circle"></i> Tasdiqlash
                </button>
            </form>
            {% endif %}
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="45">№</th>
                            <th>Xodim</th>
                            <th>Lavozim</th>
                            <th>Bo'lim</th>
                            <th>Oylik turi</th>
                            <th>Keldi</th>
                            <th>Ketdi</th>
                            <th>Soat</th>
                            <th>Holat</th>
                            <th width="80">Rasm</th>
                            <th>Izoh</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in attendance_rows %}
                        <tr class="{% if not row.attendance %}table-secondary{% endif %}">
                            <td>{{ loop.index }}</td>
                            <td>{{ row.employee.full_name }}{% if row.employee.code %} <small class="text-muted">({{ row.employee.code }})</small>{% endif %}</td>
                            <td><small>{{ row.employee.position or '-' }}</small></td>
                            <td><small>{{ row.employee.department or '-' }}</small></td>
                            <td><small>{% if row.employee.salary_type %}{% if row.employee.salary_type == 'oylik' %}Oylik{% elif row.employee.salary_type == 'soatlik' %}Soatlik{% elif row.employee.salary_type == "bo'lak" %}Bo'lak{% else %}{{ row.employee.salary_type }}{% endif %}{% else %}-{% endif %}</small></td>
                            <td>{% if row.attendance and row.attendance.check_in %}{{ row.attendance.check_in.strftime('%H:%M') }}{% else %}-{% endif %}</td>
                            <td>{% if row.attendance and row.attendance.check_out %}{{ row.attendance.check_out.strftime('%H:%M') }}{% else %}-{% endif %}</td>
                            <td>{% if row.attendance %}{{ row.attendance.hours_worked if row.attendance.hours_worked is not none else '-' }}{% else %}-{% endif %}</td>
                            <td>
                                {% if row.attendance %}
                                    {% if row.attendance.status == 'present' %}<span class="badge bg-success">Keldi</span>
                                    {% elif row.attendance.status == 'absent' %}<span class="badge bg-danger">Kelmadi</span>
                                    {% else %}{{ row.attendance.status }}{% endif %}
                                {% else %}<span class="text-muted">—</span>{% endif %}
                            </td>
                            <td>{% if row.attendance and row.attendance.event_snapshot_path %}<a href="/static/{{ row.attendance.event_snapshot_path }}" target="_blank" title="Hodisa rasmi"><img src="/static/{{ row.attendance.event_snapshot_path }}" alt="" class="rounded" style="max-width:48px;max-height:48px;object-fit:cover;"></a>{% else %}-{% endif %}</td>
                            <td><small>{% if row.attendance %}{{ row.attendance.note or '-' }}{% else %}-{% endif %}</small></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="11" class="text-center text-muted py-4">Xodimlar ro'yxati bo'sh. <a href="/info/employees">Ma'lumotnomalar → Xodimlar</a> da qo'shing.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if not doc %}
<!-- Hikvision modal (yuklashdan oldin sanani tanlash mumkin) -->
<div class="modal fade" id="hikvisionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/employees/attendance/sync-hikvision" id="hikvisionSyncForm">
                <input type="hidden" name="redirect_url" id="hikvisionRedirectUrl" value="/employees/attendance/form?date={{ form_date_str }}">
                <input type="hidden" name="start_date" id="hikvisionStartDate" value="{{ form_date_str }}">
                <input type="hidden" name="end_date" id="hikvisionEndDate" value="{{ form_date_str }}">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cloud-download"></i> Hikvision'dan yuklash</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Yuklash sanasi *</label>
                        <input type="date" class="form-control" id="hikvisionUploadDate" value="{{ form_date_str }}" required
                               title="Qaysi kun uchun davomat yuklanadi">
                        <small class="text-muted">Yuklashdan oldin sanani o'zgartirishingiz mumkin.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hikvision IP *</label>
                        <input type="text" class="form-control" name="hikvision_host" value="192.168.1.199" required>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label">Port</label>
                            <input type="number" class="form-control" name="hikvision_port" value="443">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Login</label>
                            <input type="text" class="form-control" name="hikvision_username" value="admin">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parol</label>
                        <div class="input-group">
                            <input type="password" class="form-control" name="hikvision_password" id="hikvisionPassword" placeholder="Parol" autocomplete="off">
                            {% if current_user and current_user.role == 'admin' %}
                            <button type="button" class="btn btn-outline-secondary" id="toggleHikvisionPassword" title="Parolni ko'rsatish" aria-label="Parolni ko'rsatish">
                                <i class="bi bi-eye" id="hikvisionPasswordIcon"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor</button>
                    <button type="submit" class="btn btn-success"><i class="bi bi-cloud-download"></i> Yuklash</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
(function() {
    var btn = document.getElementById('toggleHikvisionPassword');
<<<<<<< Current (Your changes)
    if (btn) {
        var inp = document.getElementById('hikvisionPassword');
        var icon = document.getElementById('hikvisionPasswordIcon');
        if (inp && icon) {
            btn.addEventListener('click', function() {
                if (inp.type === 'password') {
                    inp.type = 'text';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                    btn.title = 'Parolni yashirish';
                } else {
                    inp.type = 'password';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                    btn.title = 'Parolni ko\'rsatish';
                }
            });
        }
    }
    // Yuklashdan oldin: modaldagi sana hidden start_date, end_date va redirect ga yoziladi
    var form = document.getElementById('hikvisionSyncForm');
    var uploadDate = document.getElementById('hikvisionUploadDate');
    var startInput = document.getElementById('hikvisionStartDate');
    var endInput = document.getElementById('hikvisionEndDate');
    var redirectInput = document.getElementById('hikvisionRedirectUrl');
    if (form && uploadDate && startInput && endInput && redirectInput) {
        function syncHikvisionDate() {
            var d = uploadDate.value;
            if (d) {
                startInput.value = d;
                endInput.value = d;
                redirectInput.value = '/employees/attendance/form?date=' + d;
            }
        }
        uploadDate.addEventListener('change', syncHikvisionDate);
        form.addEventListener('submit', function() {
            syncHikvisionDate();
            var host = form.querySelector('input[name="hikvision_host"]');
            var port = form.querySelector('input[name="hikvision_port"]');
            var user = form.querySelector('input[name="hikvision_username"]');
            var pass = form.querySelector('input[name="hikvision_password"]');
            if (host && host.value) {
                try {
                    localStorage.setItem('hikvision_creds', JSON.stringify({
                        host: host.value,
                        port: (port && port.value) ? port.value : '443',
                        username: (user && user.value) ? user.value : 'admin',
                        password: (pass && pass.value) ? pass.value : ''
                    }));
                } catch (e) {}
            }
        });
    }

    // Doimiy aloqa: avtomatik yuklash har N daqiqa
    var autoSyncCheck = document.getElementById('autoSyncCheck');
    var autoSyncInterval = document.getElementById('autoSyncInterval');
    var autoSyncStatus = document.getElementById('autoSyncStatus');
    var autoSyncHint = document.getElementById('autoSyncHint');
    var autoSyncTimer = null;
    function runAutoSync() {
        var dateInp = document.getElementById('attendanceFormDate');
        var dateVal = dateInp ? dateInp.value : '';
        if (!dateVal) return;
        var credsStr = localStorage.getItem('hikvision_creds');
        if (!credsStr) {
            if (autoSyncStatus) autoSyncStatus.textContent = 'Kirish ma\'lumotlari yo\'q';
            return;
        }
        try {
            var creds = JSON.parse(credsStr);
            if (autoSyncStatus) autoSyncStatus.textContent = 'Yuklanmoqda…';
            fetch('/employees/attendance/auto-sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    date: dateVal,
                    hikvision_host: creds.host,
                    hikvision_port: creds.port || '443',
                    hikvision_username: creds.username || 'admin',
                    hikvision_password: creds.password || ''
                })
            }).then(function(r) { return r.json(); }).then(function(data) {
                if (data.success && autoSyncStatus) {
                    autoSyncStatus.textContent = 'Yangilandi: ' + (data.imported || 0) + ' ta';
                    window.location.reload();
                } else if (autoSyncStatus) {
                    autoSyncStatus.textContent = data.error || (data.errors && data.errors[0]) || 'Xato';
                }
            }).catch(function() {
                if (autoSyncStatus) autoSyncStatus.textContent = 'Tarmoq xatosi';
            });
        } catch (e) {
            if (autoSyncStatus) autoSyncStatus.textContent = 'Xato';
        }
    }
    if (autoSyncCheck && autoSyncInterval) {
        autoSyncCheck.addEventListener('change', function() {
            if (autoSyncTimer) {
                clearInterval(autoSyncTimer);
                autoSyncTimer = null;
            }
            if (this.checked) {
                var mins = parseInt(autoSyncInterval.value, 10) || 5;
                runAutoSync();
                autoSyncTimer = setInterval(runAutoSync, mins * 60 * 1000);
            } else {
                if (autoSyncStatus) autoSyncStatus.textContent = '';
            }
        });
        autoSyncInterval.addEventListener('change', function() {
            if (!autoSyncCheck.checked) return;
            if (autoSyncTimer) clearInterval(autoSyncTimer);
            var mins = parseInt(this.value, 10) || 5;
            autoSyncTimer = setInterval(runAutoSync, mins * 60 * 1000);
        });
    }
=======
    if (!btn) return;
    var inp = document.getElementById('hikvisionPassword');
    var icon = document.getElementById('hikvisionPasswordIcon');
    if (!inp || !icon) return;
    btn.addEventListener('click', function() {
        if (inp.type === 'password') {
            inp.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
            btn.title = 'Parolni yashirish';
        } else {
            inp.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
            btn.title = 'Parolni ko\'rsatish';
        }
    });
>>>>>>> Incoming (Background Agent changes)
})();
</script>
{% endblock %}
